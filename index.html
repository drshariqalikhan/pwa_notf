<!DOCTYPE html>
<html lang="en" class="is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>10 Week Transformation</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2c2c"> <!-- Default dark surface, will be updated by JS -->

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="10Wk Up">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-icon-167.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120.png">

    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-color: #48c774;
            --primary-color-light: #e6ffed;
            --dark-bg: #1a1a1a;
            --dark-surface: #2c2c2c; /* Used for app-bar, nav-bar in dark mode */
            --dark-card: #333;
            --dark-text: #e0e0e0;
            --light-bg: #f5f5f5;
            --light-surface: #fff; /* Used for app-bar, nav-bar in light mode */
            --light-card: #fff;
            --light-text: #363636;
            --app-bar-height: 75px; /* Increased height for new content */
            --nav-bar-height: 56px;
        }

        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html.is-dark { background-color: var(--dark-bg); color: var(--dark-text); }
        html.is-light-mode { background-color: var(--light-bg); color: var(--light-text); }

        .page { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease-in-out; }
        .page.is-active { display: flex; }

        #splash-page {
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            height: 100vh; background-color: var(--dark-surface); color: #fff; text-align: center;
            animation: splashFadeOut 2.5s ease-in-out forwards; animation-delay: 1s;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        html.is-light-mode #splash-page { background-color: #f0f0f0; color: #333; }
        #splash-page .title { font-size: 2.5rem; margin-bottom: 0.5em; animation: popIn 1s ease-out 0.2s forwards; opacity: 0; }
        #splash-page .subtitle { font-size: 1.25rem; animation: popIn 1s ease-out 0.5s forwards; opacity: 0; }

        .app-bar {
            height: var(--app-bar-height);
            padding: 0.5rem 0.75rem; position: fixed; top: 0; left: 0; width: 100%;
            z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out;
            display: flex; flex-direction: column; justify-content: space-around;
        }
        html.is-dark .app-bar { background-color: var(--dark-surface); color: #fff; }
        html.is-light-mode .app-bar { background-color: var(--light-surface); color: var(--light-text); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        .app-bar-stats { display: flex; justify-content: space-around; align-items: center; width: 100%; font-size: 0.75rem;}
        .app-bar-stats .stat-item { text-align: center; }
        .app-bar-stats .stat-item .heading { font-size: 0.6rem; margin-bottom: 0; text-transform: uppercase; opacity: 0.7;}
        .app-bar-stats .stat-item .title { font-size: 0.9rem; margin-bottom: 0.1rem; line-height: 1; }
        .app-bar-progress-container { width: 100%; padding: 0 0.25rem; }
        .app-bar-progress-container .progress { height: 0.5rem; margin-bottom: 0.2rem; }
        .app-bar-progress-container .progress-text { font-size: 0.6rem; text-align: center; opacity: 0.8; line-height: 1;}

        .page-title-bar { /* New bar for page specific titles */
            padding: 0.5rem 1rem;
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-top: var(--app-bar-height); /* Pushed down by app-bar */
        }
        html.is-dark .page-title-bar { background-color: var(--dark-card); /* Slightly different from app-bar */ }
        html.is-light-mode .page-title-bar { background-color: #f9f9f9; }


        .content-area {
            flex-grow: 1; overflow-y: auto; padding: 1rem;
            /* Adjust margin-top based on whether page-title-bar is used or directly app-bar height */
            margin-top: 0; /* page-title-bar will create its own margin from app-bar */
            margin-bottom: var(--nav-bar-height); animation: slideUpContent 0.6s ease-out;
            -webkit-overflow-scrolling: touch;
        }
        /* If a page doesn't have a page-title-bar, its content-area might need direct margin-top */
        .content-area.no-page-title { margin-top: var(--app-bar-height); }


        .card-collection-container { position: relative; margin-top: 0.5rem; }
        .card-collection { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 1rem; -webkit-overflow-scrolling: touch; }
        /* ... Other existing styles ... */
        .card-collection .card .title { font-size: 1.1rem; }
        .card-collection .card .subtitle { font-size: 0.85rem; }
        
        /* Nav Bar (Bottom) */
        .nav-bar {
            height: var(--nav-bar-height);
            position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around;
            padding: 0.3rem 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 100; animation: slideUp 0.5s ease-out;
        }
        /* ... Other existing nav-bar styles ... */

        /* Utility & Theming Adjustments */
        .is-fullheight-with-fixed { min-height: calc(100vh - var(--app-bar-height) - var(--nav-bar-height) - 46px); /* 46px for typical page-title-bar height */ display: flex; flex-direction: column; justify-content: center; }
        .content-area.is-fullheight-no-title { min-height: calc(100vh - var(--app-bar-height) - var(--nav-bar-height)); display: flex; flex-direction: column; justify-content: center;}
        
        html.is-dark .app-bar-stats .stat-item .heading { color: #aaa; }
        html.is-light-mode .app-bar-stats .stat-item .heading { color: #777; }
        html.is-dark .app-bar-progress-container .progress-text { color: #ccc; }
        html.is-light-mode .app-bar-progress-container .progress-text { color: #555; }
        
        /* Ensure Bulma checkbox/radio and switch are visible in dark mode */
        /* ... (keep existing dark mode adjustments for forms, boxes etc.) ... */
        html.is-dark .checkbox input[type="checkbox"] + span::before,
        html.is-dark .radio input[type="radio"] + span::before {
            border-color: #777;
        }
        html.is-dark .checkbox input[type="checkbox"]:checked + span::before,
        html.is-dark .radio input[type="radio"]:checked + span::before {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        html.is-dark .switch input[type=checkbox]+.check { background: #555; }
        html.is-dark .switch input[type=checkbox]:checked+.check { background: var(--primary-color); }
        html.is-dark .label { color: #ccc; }
        html.is-dark .input, html.is-dark .textarea, html.is-dark .select select {
            background-color: #444; border-color: #555; color: var(--dark-text);
        }
        html.is-dark .input::placeholder, html.is-dark .textarea::placeholder { color: #888; }
        html.is-dark .box { background-color: var(--dark-card); }
        html.is-dark .notification.is-info.is-light { background-color: rgba(72, 199, 116, 0.1); color: #b8ebd0; }
        html.is-dark .notification.is-warning.is-light { background-color: rgba(255, 221, 87, 0.1); color: #ffe99a; }
        html.is-light-mode .notification.is-info.is-light { background-color: #eefaf3; color: #216e45; }
        html.is-light-mode .notification.is-warning.is-light { background-color: #fffbeb; color: #947600; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes splashFadeOut { 0% { opacity: 1; visibility: visible; } 99% { opacity: 0; visibility: visible; } 100% { opacity: 0; visibility: hidden; } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideUpContent { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
        /* Card styles from previous steps */
        .card-collection .card .card-content { padding: 1rem; }
        .card.is-task-done { opacity: 0.85; }
        html.is-dark .card.is-task-done { background-color: #2a523d; border-left: 5px solid var(--primary-color); }
        html.is-light-mode .card.is-task-done { background-color: var(--primary-color-light); border-left: 5px solid var(--primary-color); }
        .task-done-checkbox-container { margin-top: 1rem; padding-top: 0.75rem; }
        html.is-dark .task-done-checkbox-container { border-top: 1px solid #444; }
        html.is-light-mode .task-done-checkbox-container { border-top: 1px solid #ddd; }
        .task-done-checkbox-label { display: flex; align-items: center; font-size: 0.9rem; }
        .task-done-checkbox-label .icon { margin-right: 0.5em; }
        html.is-dark .task-done-checkbox-label { color: var(--dark-text); }
        html.is-light-mode .task-done-checkbox-label { color: var(--light-text); }
        .card.is-disappearing {
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, height 0.4s ease-in-out 0.1s, margin 0.4s ease-in-out 0.1s, padding 0.4s ease-in-out 0.1s;
            transform: translateY(-80px) scale(0.8) rotateX(30deg); opacity: 0 !important; height: 0 !important;
            margin: 0 !important; padding: 0 !important; overflow: hidden; pointer-events: none;
        }
        .modal .modal-card-body { max-height: 70vh; }
        .llm-chat-history { max-height: 200px; overflow-y: auto; border: 1px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem;}
        html.is-light-mode .llm-chat-history { border-color: #ccc; }
        .llm-chat-history p { margin-bottom: 5px; }
        .llm-chat-history .user-message { text-align: right; }
        html.is-dark .llm-chat-history .user-message { color: #a1d9ff; }
        html.is-light-mode .llm-chat-history .user-message { color: #007bff; }
        .llm-chat-history .bot-message { text-align: left; }
        html.is-dark .llm-chat-history .bot-message { color: var(--dark-text); }
        html.is-light-mode .llm-chat-history .bot-message { color: var(--light-text); }

    </style>
</head>
<body>
    <!-- Universal App Bar -->
    <header class="app-bar">
        <div class="app-bar-stats">
            <div class="stat-item">
                <p class="heading">Points</p>
                <p class="title" id="app-bar-user-points">0</p>
            </div>
            <div class="stat-item">
                <p class="heading">Streak</p>
                <p class="title" id="app-bar-user-streak">0d</p>
            </div>
        </div>
        <div class="app-bar-progress-container">
            <progress class="progress is-primary is-small" id="app-bar-challenge-progress-bar" value="0" max="70"></progress>
            <p class="progress-text" id="app-bar-challenge-progress-text">W1 D1</p>
        </div>
    </header>

    <div id="splash-page">
        <h1 class="title is-1">10 Weeks Up</h1>
        <h2 class="subtitle is-3">Your Transformation Journey.</h2>
        <progress class="progress is-small is-primary" max="100" style="width: 60%; margin-top: 20px;">15%</progress>
    </div>

    <!-- Registration Page -->
    <div id="registration-page" class="page">
        <!-- App bar is universal, no need to repeat -->
        <div class="page-title-bar">Welcome!</div>
        <main class="content-area is-fullheight-no-title"> <!-- content-area.no-page-title or is-fullheight-with-fixed depending on design -->
            <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Let's Get Started</h1>
                <p class="subtitle is-5 has-text-centered">Tell us a bit about yourself.</p>
                <form id="registration-form">
                    <!-- Form fields from previous version -->
                    <div class="field"><label class="label">Name</label><div class="control"><input class="input" type="text" id="reg-name" placeholder="Your Name" required></div></div>
                    <div class="field"><label class="label">Age</label><div class="control"><input class="input" type="number" id="reg-age" placeholder="e.g., 30" required min="16" max="99"></div></div>
                    <div class="field"><label class="label">Gender</label><div class="control"><div class="select is-fullwidth"><select id="reg-gender" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div></div></div>
                    <div class="field"><label class="label">Weight (kg)</label><div class="control"><input class="input" type="number" id="reg-weight" placeholder="e.g., 70" step="0.1" required></div></div>
                    <div class="field"><label class="label">Height (cm)</label><div class="control"><input class="input" type="number" id="reg-height" placeholder="e.g., 175" required></div></div>
                    <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Baseline</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Questionnaire/Baseline Page -->
    <div id="questionnaire-page" class="page">
        <div class="page-title-bar">Baseline Assessment</div>
        <main class="content-area is-fullheight-no-title">
             <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Your Starting Point</h1>
                <p class="subtitle is-5 has-text-centered">Record your initial performance.</p>
                <form id="baseline-form">
                     <!-- Form fields from previous version -->
                    <div class="field"><label class="label">Cardio Capacity (e.g., Mins of continuous jogging, or reps in 1 min jump test)</label><div class="control"><input class="input" type="number" id="baseline-cardio" placeholder="e.g., 5 (mins) or 30 (reps)" required></div></div>
                    <div class="field"><label class="label">Strength Reps (e.g., Max push-ups or squats)</label><div class="control"><input class="input" type="number" id="baseline-strength" placeholder="e.g., 10" required></div></div>
                    <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Choose Track</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Exercise Track Selection Page -->
    <div id="exercise-track-selection-page" class="page">
        <div class="page-title-bar">Choose Your Path</div>
        <main class="content-area is-fullheight-no-title">
            <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Select Exercise Track</h1>
                <p class="subtitle is-5 has-text-centered">Pick a track that suits your current fitness level.</p>
                <div class="buttons are-medium is-centered are-vertical">
                    <button class="button is-info is-fullwidth" data-track="beginner">Beginner Track</button>
                    <button class="button is-warning is-fullwidth" data-track="intermediate">Intermediate Track</button>
                    <button class="button is-danger is-fullwidth" data-track="advanced">Advanced Track</button>
                </div>
                <p class="is-size-7 mt-4 has-text-centered">Tracks will escalate weekly based on your baseline, age, and gender.</p>
            </div>
        </main>
    </div>

    <!-- Home Page (Dashboard) -->
    <div id="home-page" class="page">
        <!-- App bar is universal -->
        <div class="page-title-bar" id="home-page-title-bar">Daily Tasks</div> <!-- Page specific title -->
        <main class="content-area">
            <!-- Motivate me now button can be placed here if desired, e.g. -->
             <button id="motivate-me-now-button-main" class="button is-primary is-fullwidth mb-3">Need a Boost? Motivate Me!</button>
            
            <div id="welcome-back-message" class="notification is-info is-light" style="display:none;"></div>
            <div id="daily-task-reminder" class="notification is-warning is-light mb-3" style="display:none;">
                Don't forget your daily tasks! <button id="request-notification-permission" class="button is-small is-warning">Enable Reminders</button>
            </div>
            <div class="card-collection-container">
                <div class="card-collection" id="home-card-collection">
                    <div class="card"><div class="card-content"><p class="has-text-centered p-5">Loading tasks...</p></div></div>
                </div>
            </div>
             <div class="content mt-4">
                <h3 class="title is-4">Your Dashboard Info</h3>
                <div id="user-info-dashboard" class="box content is-small"></div>
                <div id="gamification-badges" class="box">
                    <h4 class="title is-5">My Badges</h4>
                    <div id="badges-display" class="tags"></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item is-active" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <!-- Changed from Ideas -->
            <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>

    <!-- Motivate Page (was Ideas) -->
    <div id="motivate-page" class="page">
        <div class="page-title-bar">Get Motivated</div>
        <main class="content-area">
            <h1 class="title">Find Your Spark!</h1>
            <div id="educational-content-motivation" class="box content">
                <h4>Why is motivation important?</h4>
                <p>Motivation is the driving force behind achieving your goals...</p>
                <h4>How habit formation works:</h4>
                <p>Habits are formed through repetition (cue, routine, reward)...</p>
            </div>
             <div class="box"><p class="is-size-5 has-text-centered">"The journey of a thousand miles begins with a single step." - Lao Tzu</p></div>
             <div class="box"><p class="is-size-5 has-text-centered">"Success is not final, failure is not fatal: It is the courage to continue that counts." - Winston Churchill</p></div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item is-active" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a>
            <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>

    <!-- Quit Habit Page -->
    <div id="quit-page" class="page">
        <div class="page-title-bar">Change a Habit</div>
        <main class="content-area">
            <h1 class="title">Your Habit Focus</h1>
            <div id="quit-habit-content" class="box"></div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a>
            <a href="#" class="nav-item is-active" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>
    
    <!-- My Progress Page -->
    <div id="progress-page" class="page">
        <div class="page-title-bar">My Progress</div>
        <main class="content-area">
            <h1 class="title">Your Transformation Journey</h1>
            <!-- Content from previous version -->
            <div class="box"><h3 class="title is-5">Weight Trend</h3><p>Initial Weight: <span id="prog-initial-weight" class="has-text-weight-bold">N/A</span> kg</p><p>Current Weight (Manual Log): <input type="number" id="prog-log-current-weight" class="input is-small" style="width: 80px; display: inline-block;" placeholder="Log"> kg <button id="save-prog-current-weight" class="button is-small is-link">Save</button></p><p>Logged Weight: <span id="prog-current-weight-display" class="has-text-weight-bold">N/A</span> kg</p><p>Target Ideal Weight: <span id="prog-target-weight" class="has-text-weight-bold">N/A</span> kg</p></div>
            <div class="box"><h3 class="title is-5">Exercise Improvement</h3><p>Baseline Cardio: <span id="prog-baseline-cardio" class="has-text-weight-bold">N/A</span></p><p>Best Cardio This Week (Conceptual): <span id="prog-current-cardio" class="has-text-weight-bold">N/A</span></p><p>Baseline Strength: <span id="prog-baseline-strength" class="has-text-weight-bold">N/A</span></p><p>Best Strength This Week (Conceptual): <span id="prog-current-strength" class="has-text-weight-bold">N/A</span></p></div>
            <div class="box"><h3 class="title is-5">Mood & Stress (Last 7 days average - Conceptual)</h3><p>Average Mood: <span id="prog-avg-mood" class="has-text-weight-bold">N/A</span> / 5</p><p>Average Stress: <span id="prog-avg-stress" class="has-text-weight-bold">N/A</span> / 5</p></div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a>
            <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item is-active" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
        <div class="page-title-bar">Settings</div>
        <main class="content-area">
            <h1 class="title">App Settings</h1>
            <!-- Content from previous version -->
            <div class="field"><label class="label">Theme</label><div class="control"><label class="theme-toggle-label" for="theme-toggle-checkbox"><input type="checkbox" id="theme-toggle-checkbox"><span class="theme-toggle-icon-container"><span class="icon dark-icon"><i class="fas fa-moon"></i></span><span class="icon light-icon" style="display:none;"><i class="fas fa-sun"></i></span></span><span id="theme-toggle-text" class="ml-2">Toggle</span></label></div></div>
            <div class="field mt-4"><label class="label">Notifications</label><div class="control"><label class="switch is-rounded is-primary"><input type="checkbox" id="notifications-enabled-switch"><span class="check"></span><span class="control-label ml-2">Daily Reminders</span></label></div></div>
            <div class="field mt-5"><button class="button is-link is-fullwidth">My Account (Placeholder)</button></div>
            <div class="field mt-3"><button class="button is-outlined is-fullwidth" id="community-forum-link">Community Forum (Link)</button></div>
            <div class="field mt-3"><button id="reset-app-data" class="button is-danger is-fullwidth">Reset All App Data</button></div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a>
            <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item is-active" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>

    <!-- Motivate Me Now Modal -->
    <div id="motivate-me-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head"><p class="modal-card-title">Motivate Me Now!</p><button class="delete" aria-label="close"></button></header>
            <section class="modal-card-body">
                <!-- Content from previous version -->
                <div class="field"><label class="label">Task you need motivation for?</label><div class="control"><div class="select is-fullwidth"><select id="motivation-task-select"><option value="general">General</option><option value="sleep">Sleep</option><option value="weight">Weight</option><option value="exercise">Exercise</option><option value="peace">Peace</option><option value="quitHabit">Habit</option></select></div></div></div>
                <div id="motivation-llm-response-area" class="content mt-4" style="display:none;"><h4 class="subtitle is-5">Pep Talk:</h4><p id="motivation-llm-text">Loading...</p></div>
            </section>
            <footer class="modal-card-foot"><button id="get-motivation-button" class="button is-success">Get Pep Talk</button><button class="button modal-close-button">Cancel</button></footer>
        </div>
    </div>

    <!-- LLM Chat Modal (for Peace of Mind) -->
    <div id="llm-chat-modal" class="modal">
        <div class="modal-background"></div>
        <div class="modal-card">
            <header class="modal-card-head"><p class="modal-card-title">Talk About Stress Triggers</p><button class="delete" aria-label="close"></button></header>
            <section class="modal-card-body">
                <!-- Content from previous version -->
                <p class="is-size-7 mb-2">Simulated chat. Responses are pre-defined.</p><div id="llm-chat-history-peace" class="llm-chat-history"></div><div class="field has-addons"><div class="control is-expanded"><input id="llm-chat-input-peace" class="input" type="text" placeholder="Tell me about a stress trigger..."></div><div class="control"><button id="llm-chat-send-peace" class="button is-info">Send</button></div></div>
            </section>
            <footer class="modal-card-foot"><button class="button modal-close-button">Done</button></footer>
        </div>
    </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('ServiceWorker registration successful: ', registration.scope))
                    .catch(error => console.log('ServiceWorker registration failed: ', error));
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-bar .nav-item');
            // App Bar Elements
            const appBarUserPoints = document.getElementById('app-bar-user-points');
            const appBarUserStreak = document.getElementById('app-bar-user-streak');
            const appBarChallengeProgressBar = document.getElementById('app-bar-challenge-progress-bar');
            const appBarChallengeProgressText = document.getElementById('app-bar-challenge-progress-text');
            
            const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');
            // ... (other elements)
            const motivateMeNowButtonMain = document.getElementById('motivate-me-now-button-main'); // New button on home page
            const motivateMeModal = document.getElementById('motivate-me-modal');
            const llmChatModal = document.getElementById('llm-chat-modal');
            const homeCardCollection = document.getElementById('home-card-collection');


            // --- App Data (same as before) ---
            let appData = { /* ... */ };

            // --- Constants (same as before) ---
            const TOTAL_WEEKS = 10; const DAYS_IN_WEEK = 7; const TOTAL_DAYS = TOTAL_WEEKS * DAYS_IN_WEEK;

            // --- Utility Functions (saveAppData, loadAppData, showPage, calculateCurrentChallengeDay, getTodayProgressKey, getProgressForToday - same as before, slight adjustment to showPage if needed for title) ---
            const getDayOfYear = (date = new Date()) => Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const saveAppData = () => { try { localStorage.setItem('transformationAppData', JSON.stringify(appData)); } catch (e) { console.error("LS Save Error:", e); }};
            const loadAppData = () => { /* ... (same as before, ensure all nested objects are initialized) ... */ 
                const data = localStorage.getItem('transformationAppData');
                if (data) {
                    try {
                        appData = JSON.parse(data);
                        appData.user = appData.user || null;
                        appData.baseline = appData.baseline || null;
                        appData.dailyProgress = appData.dailyProgress || {};
                        appData.weeklyGratitude = appData.weeklyGratitude || {};
                        appData.gamification = appData.gamification || { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null };
                        if(!appData.gamification.hasOwnProperty('lastWeightLog')) appData.gamification.lastWeightLog = null;
                        appData.settings = appData.settings || { notificationsEnabled: false, theme: 'dark' };
                        appData.habitChallenge = appData.habitChallenge || { behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null };
                    } catch (e) { console.error("LS Parse Error:", e); localStorage.removeItem('transformationAppData'); }
                }
            };
             const showPage = (pageId) => {
                pages.forEach(page => page.classList.remove('is-active'));
                const activePage = document.getElementById(pageId);
                if (activePage) {
                    activePage.classList.add('is-active');
                    // Update page-specific title if the page has one
                    const pageTitleBar = activePage.querySelector('.page-title-bar');
                    if (pageTitleBar && appData.user && pageId === 'home-page') { // Example for home page title
                        pageTitleBar.textContent = `Hi, ${appData.user.name}!`;
                    } else if (pageTitleBar) {
                        // pageTitleBar might have static text in HTML or be updated here for other pages
                    }
                }
                navItems.forEach(item => item.classList.toggle('is-active', item.dataset.page === pageId));
                window.scrollTo(0,0); 
            };
            const calculateCurrentChallengeDay = () => { /* ... (same as before) ... */ 
                if (!appData.user || !appData.user.registrationDate) return { week: 1, day: 1, overallDay: 1 };
                const regDate = new Date(appData.user.registrationDate);
                const today = new Date();
                regDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
                const diffTime = Math.abs(today - regDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                let overallDay = diffDays + 1;
                if (overallDay > TOTAL_DAYS) overallDay = TOTAL_DAYS;
                const currentWeek = Math.min(TOTAL_WEEKS, Math.floor((overallDay -1) / DAYS_IN_WEEK) + 1);
                const dayInWeek = ((overallDay -1) % DAYS_IN_WEEK) + 1;
                return { week: currentWeek, day: dayInWeek, overallDay: overallDay };
            };
            const getTodayProgressKey = () => { /* ... (same as before) ... */ 
                const { week, day } = calculateCurrentChallengeDay(); return `week${week}day${day}`;
            };
            const getProgressForToday = (createIfMissing = true) => { /* ... (same as before, ensure llmChat:[] is in peace object) ... */
                const key = getTodayProgressKey();
                if (!appData.dailyProgress[key] && createIfMissing) {
                    appData.dailyProgress[key] = {
                        sleep: { completed: false, bedtime: '', wakeup: '', duration: '', targetMet: null },
                        weight: { completed: false, meals: [], water: 0, foodLog: '', nonWater: '', junkAvoided: false, fruitSnacks: false, adheredMealTimes: false, calories: null },
                        exercise: { completed: false, cardioDone: false, strengthDone: false },
                        peace: { completed: false, mindfulnessDone: false, moodBefore: 3, stressBefore: 3, moodAfter: 3, stressAfter: 3, breathingDone: false, enjoyableActivityDone: false, llmChat: [] },
                        tasksCompletedCount: 0 
                    };
                }
                return appData.dailyProgress[key] || null;
            };


            // --- Theme ---
            const updateThemeMeta = (isLight) => {
                const rootStyle = getComputedStyle(document.documentElement);
                const themeColor = isLight ? rootStyle.getPropertyValue('--light-surface').trim() : rootStyle.getPropertyValue('--dark-surface').trim();
                document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor || '#2c2c2c');
            };
            const applyTheme = (isLight) => { /* ... (same as before, ensure darkIcon/lightIcon/themeToggleText null checks) ... */
                document.documentElement.classList.toggle('is-light-mode', isLight);
                document.documentElement.classList.toggle('is-dark', !isLight);
                if (themeToggleCheckbox) themeToggleCheckbox.checked = isLight;
                const darkIcon = document.querySelector('.theme-toggle-icon-container .dark-icon');
                const lightIcon = document.querySelector('.theme-toggle-icon-container .light-icon');
                const themeToggleText = document.getElementById('theme-toggle-text');
                if (darkIcon) darkIcon.style.display = isLight ? 'none' : 'inline-flex';
                if (lightIcon) lightIcon.style.display = isLight ? 'inline-flex' : 'none';
                if (themeToggleText) themeToggleText.textContent = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
                appData.settings.theme = isLight ? 'light' : 'dark';
                updateThemeMeta(isLight);
                saveAppData();
            };

            // --- Page Navigation & Modals ---
            navItems.forEach(item => { /* ... (same as before) ... */ });
            function setupModal(modalElement, openButtons, closeButtonsSelectors) { /* ... (same as before) ... */
                const openModal = () => modalElement.classList.add('is-active');
                const closeModal = () => modalElement.classList.remove('is-active');
                if (openButtons) { (Array.isArray(openButtons) ? openButtons : [openButtons]).forEach(btn => btn?.addEventListener('click', openModal)); }
                modalElement.querySelectorAll(closeButtonsSelectors).forEach(btn => btn.addEventListener('click', closeModal));
                return { openModal, closeModal };
            }
            const motivateModalControls = setupModal(motivateMeModal, motivateMeNowButtonMain, '.modal-background, .delete, .modal-close-button');
            const llmChatModalControls = setupModal(llmChatModal, null, '.modal-background, .delete, .modal-close-button');


            // --- Initial Setup Flow (handleRegistration, handleBaseline, handleTrackSelection - same as before) ---
            const handleRegistration = (e) => { /* ... (same as before) ... */ e.preventDefault(); const name = document.getElementById('reg-name').value; const age = parseInt(document.getElementById('reg-age').value); const gender = document.getElementById('reg-gender').value; const weight = parseFloat(document.getElementById('reg-weight').value); const height = parseInt(document.getElementById('reg-height').value); const heightM = height / 100; const idealBmiHealthy = 22; const idealWeight = Math.round(idealBmiHealthy * (heightM * heightM)); let bmr; if (gender === 'male') { bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age); } else if (gender === 'female') { bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age); } else { bmr = (88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age) + 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age)) / 2;} const caloricDeficit = 500; appData.user = { name, age, gender, weight, height, registrationDate: new Date().toISOString(), idealWeight, caloricDeficit, bmr: Math.round(bmr), exerciseTrack: null, currentDayOfYear: getDayOfYear(), lastLoginDayOfYear: getDayOfYear() }; appData.gamification = { points: 0, badges: [], dailyStreak: 0, lastWeightLog: { date: new Date().toISOString().split('T')[0], weight: weight } }; appData.dailyProgress = {}; appData.weeklyGratitude = {}; saveAppData(); showPage('questionnaire-page');};
            const handleBaseline = (e) => { /* ... (same as before) ... */  e.preventDefault(); appData.baseline = { cardioValue: parseInt(document.getElementById('baseline-cardio').value), strengthValue: parseInt(document.getElementById('baseline-strength').value) }; saveAppData(); showPage('exercise-track-selection-page');};
            const handleTrackSelection = (track) => { /* ... (same as before) ... */ appData.user.exerciseTrack = track; saveAppData(); initializeAppDashboard(); };
            document.getElementById('registration-form')?.addEventListener('submit', handleRegistration);
            document.getElementById('baseline-form')?.addEventListener('submit', handleBaseline);
            document.querySelectorAll('#exercise-track-selection-page .button').forEach(btn => btn.addEventListener('click', () => handleTrackSelection(btn.dataset.track)));

            // --- Notifications (same as before) ---
            const requestNotificationPermission = async () => { /* ... */ return false; }; const showDailyReminderNotification = () => { /* ... */ };
            document.getElementById('request-notification-permission')?.addEventListener('click', async () => { /* ... */ });
            document.getElementById('notifications-enabled-switch')?.addEventListener('change', async (e) => { /* ... */ });

            // --- Daily Task Card Rendering (createTaskCard, createSleepCard, etc. - same as before) ---
            const renderDailyTasks = () => { /* ... (same as before) ... */ };
            const createTaskCard = (title, iconClass) => { /* ... (same as before) ... */ const card = document.createElement('div'); card.className = 'card'; const cardContent = document.createElement('div'); cardContent.className = 'card-content'; const cardTitle = document.createElement('p'); cardTitle.className = 'title is-5'; cardTitle.innerHTML = `<span class="icon is-small mr-2"><i class="${iconClass}"></i></span>${title}`; cardContent.appendChild(cardTitle); card.appendChild(cardContent); return {card, cardContent};};
            function createSleepCard(week, day, sleepData) { /* ... (same as before) ... */ return document.createElement('div');}
            function createWeightControlCard(week, day, weightData) { /* ... (same as before) ... */ return document.createElement('div');}
            function createExerciseCard(week, day, exerciseData) { /* ... (same as before) ... */ return document.createElement('div');}
            function getExerciseRoutine(track, week, gender, age, baseline) { /* ... (same as before) ... */ return {cardio:"", strength:""};}
            function createPeaceOfMindCard(week, day, peaceData) { /* ... (same as before) ... */ return document.createElement('div');}
            function createQuitHabitSummaryCard(week, day) { /* ... (same as before) ... */ return document.createElement('div');}
            function createTaskDoneCheckbox(taskType, isChecked, labelText) { /* ... (same as before) ... */ return "";}

            // --- Card Event Listeners Setup (same as before, ensure mindfulnessInterval is declared) ---
            let mindfulnessInterval; function setupCardEventListeners() { /* ... (same as before) ... */ }
            function startMindfulnessTimer() { /* ... (same as before) ... */ }

            // --- Quit Habit Page Logic (same as before) ---
            function renderQuitHabitPage() { /* ... (same as before) ... */ }

            // --- Progress Page Logic (same as before) ---
            function renderProgressPage() { /* ... (same as before) ... */ }
            document.getElementById('save-prog-current-weight')?.addEventListener('click', () => { /* ... */ });

            // --- Gamification (addPoints, awardBadge - same as before) ---
            const addPoints = (amount) => { /* ... */ appData.gamification.points = Math.max(0, appData.gamification.points + amount); };
            const awardBadge = (badgeName, badgeIconClass) => { /* ... (same as before, ensure badgeAlert is handled if doc fragment) ... */ };
            
            // MODIFIED: Update App Bar Gamification Display
            const updateAppBarGamificationDisplay = () => {
                if (!appData.user) return; // Don't update if no user data (e.g., on registration pages)

                appBarUserPoints.textContent = appData.gamification.points;
                appBarUserStreak.textContent = `${appData.gamification.dailyStreak}d`;
                
                const { week, day, overallDay } = calculateCurrentChallengeDay();
                appBarChallengeProgressBar.value = overallDay;
                appBarChallengeProgressBar.max = TOTAL_DAYS;
                appBarChallengeProgressText.textContent = `W${week} D${day}`;

                // Update badges on home page as before
                const badgesDisplay = document.getElementById('badges-display');
                if(badgesDisplay) { // Only if on a page that has this element
                    badgesDisplay.innerHTML = '';
                    appData.gamification.badges.forEach(badge => {
                        badgesDisplay.innerHTML += `<span class="tag is-medium is-success"><span class="icon is-small mr-1"><i class="${badge.icon}"></i></span>${badge.name}</span>`;
                    });
                }
            };

            const checkAllDailyTasksCompletion = () => { /* ... (same as before, calls updateAppBarGamificationDisplay) ... */ 
                 const todayProgress = getProgressForToday(false); if (!todayProgress) return;
                const mainTasks = ['sleep', 'weight', 'exercise', 'peace']; const allMainTasksDone = mainTasks.every(taskType => todayProgress[taskType]?.completed);
                const todayKey = getTodayProgressKey(); const habitTaskDone = appData.habitChallenge.log[todayKey]?.completedToday;
                if (allMainTasksDone && habitTaskDone) { if (!todayProgress.allDayTasksMarkedDone) { appData.gamification.dailyStreak++; addPoints(25); todayProgress.allDayTasksMarkedDone = true; if(appData.gamification.dailyStreak > 0 && appData.gamification.dailyStreak % 7 === 0){ awardBadge(`${appData.gamification.dailyStreak/7} Week Streak!`, 'fas fa-fire');}}} else { if (todayProgress.allDayTasksMarkedDone) {} todayProgress.allDayTasksMarkedDone = false;}
                const { week, day } = calculateCurrentChallengeDay(); if (day === DAYS_IN_WEEK && allMainTasksDone && habitTaskDone) { checkAndAwardWeeklyBadges(week); }
                saveAppData(); updateAppBarGamificationDisplay(); // Ensure app bar updates
            };
            const checkAndAwardWeeklyBadges = (weekCompleted) => { /* ... (same as before, calls updateAppBarGamificationDisplay) ... */ 
                 awardBadge(`Week ${weekCompleted} Complete!`, 'fas fa-trophy'); if (weekCompleted === 1) awardBadge('First Week Finisher', 'fas fa-star'); if (weekCompleted === Math.floor(TOTAL_WEEKS / 2)) awardBadge('Halfway Hero', 'fas fa-medal'); if (weekCompleted === TOTAL_WEEKS) awardBadge('Transformation Champion!', 'fas fa-crown'); addPoints(50 * weekCompleted); updateAppBarGamificationDisplay();
            };


            // --- LLM Simulation (same as before) ---
            const getLLMSimulatedResponse = (type, input, context = null) => { /* ... */ return new Promise(r => setTimeout(()=>r("Simulated LLM response."),100)); };
            document.getElementById('get-motivation-button')?.addEventListener('click', async () => { /* ... */ });
            let peaceChatHistory = []; const llmChatHistoryPeaceDiv = document.getElementById('llm-chat-history-peace'); const llmChatInputPeace = document.getElementById('llm-chat-input-peace');
            const renderLlmChatHistory = (contextType) => { /* ... */ };
            document.getElementById('llm-chat-send-peace')?.addEventListener('click', async () => { /* ... */ });


            // --- App Initialization & Daily Logic ---
            const initializeAppDashboard = () => {
                if (!appData.user) { showPage('registration-page'); return; }
                // Set home page specific title
                const homeTitleBar = document.getElementById('home-page-title-bar');
                if (homeTitleBar) homeTitleBar.textContent = `Hi, ${appData.user.name}!`;
                
                showPage('home-page'); // Show home first, then update UI elements
                
                const { week, day, overallDay } = calculateCurrentChallengeDay();
                appData.user.currentWeek = week;

                const todayOfYear = getDayOfYear();
                const welcomeMsgDiv = document.getElementById('welcome-back-message');
                if (appData.user.lastLoginDayOfYear) {
                    if (todayOfYear === appData.user.lastLoginDayOfYear) { welcomeMsgDiv.style.display = 'none'; } 
                    else if (todayOfYear === appData.user.lastLoginDayOfYear + 1) { welcomeMsgDiv.style.display = 'none'; } 
                    else { appData.gamification.dailyStreak = 0; welcomeMsgDiv.textContent = `Welcome back, ${appData.user.name}! Back on Week ${week}, Day ${day}.`; welcomeMsgDiv.style.display = 'block'; }
                }
                appData.user.lastLoginDayOfYear = todayOfYear;

                // Update App Bar stats universally
                updateAppBarGamificationDisplay(); 

                const userInfoDiv = document.getElementById('user-info-dashboard');
                if (userInfoDiv) { // Check if element exists on current page
                    userInfoDiv.innerHTML = `<p><strong>Name:</strong> ${appData.user.name}</p> <!-- ... more user info ... -->`;
                }
                renderDailyTasks(); 

                const todayProgressExists = getProgressForToday(false);
                const allTasksDoneToday = todayProgressExists ? Object.values(todayProgressExists).every(task => typeof task === 'object' ? task.completed : true) && appData.habitChallenge.log[getTodayProgressKey()]?.completedToday : false;
                const dailyReminderDiv = document.getElementById('daily-task-reminder');
                if (!allTasksDoneToday) { dailyReminderDiv.style.display = 'block'; showDailyReminderNotification(); } 
                else { dailyReminderDiv.style.display = 'none'; }
                saveAppData();
            };


            // Reset App Data (same as before) ---
            document.getElementById('reset-app-data')?.addEventListener('click', () => { /* ... */ });
            document.getElementById('community-forum-link')?.addEventListener('click', () => { /* ... */ });


            // --- App Start ---
            loadAppData();
            applyTheme(appData.settings.theme === 'light'); 
             if (themeToggleCheckbox) { themeToggleCheckbox.addEventListener('change', () => applyTheme(themeToggleCheckbox.checked)); }
            const notificationsSwitch = document.getElementById('notifications-enabled-switch');
            if(notificationsSwitch) notificationsSwitch.checked = appData.settings.notificationsEnabled;

            updateAppBarGamificationDisplay(); // Update app bar on initial load if user data exists

            const splashTimeout = (appData.user && appData.user.registrationDate) ? 1500 : 2600;
            setTimeout(() => {
                const splash = document.getElementById('splash-page');
                if (splash) splash.style.opacity = '0';
                setTimeout(() => {
                     if (splash) splash.style.display = 'none';
                     if (!appData.user) { showPage('registration-page'); } 
                     else if (!appData.baseline) { showPage('questionnaire-page'); } 
                     else if (!appData.user.exerciseTrack) { showPage('exercise-track-selection-page'); } 
                     else { initializeAppDashboard(); }
                }, 500);
            }, splashTimeout - 500);
        });
    </script>
</body>
</html>