<!DOCTYPE html>
<html lang="en" class="is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>10 Week Transformation</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2c2c"> <!-- Default dark surface, will be updated by JS -->

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="10Wk Up">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-icon-167.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120.png">

    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Dark Theme (Default) */
            --primary-color: #48c774; 
            --primary-color-light: #40208a; 
            --dark-bg: #1a1a1a;
            --dark-surface: #2c2c2c; 
            --dark-card: #333; 
            --dark-text: #e0e0e0;
            --dark-text-muted: #999;
            --dark-border: #444;
        
            /* Light Theme - NEW PALETTE */
            --light-bg: #fafafa; 
            --light-surface: #ffffff; 
            --light-card: #f8f9fa; 
            --light-text: #2e3440; 
            --light-text-muted: #7b8691; 
            --light-border: #e4e7ec; 
            --light-primary-accent: #ff7eb3; 
            --light-primary-accent-hover: #e6649d; 
            --light-success-accent: #32d296; 


            --app-bar-height: 75px; 
            --nav-bar-height: 56px;
            --page-title-bar-height: 46px;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }

        html.is-dark { background-color: var(--dark-bg); color: var(--dark-text); }
        html.is-light-mode { background-color: var(--light-bg); color: var(--light-text); }

        .page { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease-in-out; }
        .page.is-active { display: flex; }

        #splash-page { 
            display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100vh; text-align: center; animation: splashFadeOut 2.5s ease-in-out forwards; animation-delay: 1s; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        html.is-dark #splash-page { background-color: var(--dark-surface); color: #fff;}
        html.is-light-mode #splash-page { background-color: var(--light-surface); color: var(--light-text);}
        #splash-page .title { font-size: 2.5rem; margin-bottom: 0.5em; animation: popIn 1s ease-out 0.2s forwards; opacity: 0; }
        #splash-page .subtitle { font-size: 1.25rem; animation: popIn 1s ease-out 0.5s forwards; opacity: 0; }


        .app-bar {
            display: none; 
            height: var(--app-bar-height); padding: 0.5rem 0.75rem; position: fixed; top: 0; left: 0; width: 100%;
            z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out;
            flex-direction: column; justify-content: space-around;
        }
        .app-bar.is-visible { display: flex; }
        html.is-dark .app-bar { background-color: var(--dark-surface); color: #fff; }
        html.is-light-mode .app-bar { background-color: var(--light-surface); color: var(--light-text); box-shadow: 0 2px 5px rgba(0,0,0,0.08); }

        .app-bar-stats { display: flex; justify-content: space-around; align-items: center; width: 100%; font-size: 0.75rem;}
        .app-bar-stats .stat-item { text-align: center; }
        .app-bar-stats .stat-item .heading { font-size: 0.6rem; margin-bottom: 0; text-transform: uppercase; }
        .app-bar-stats .stat-item .title { font-size: 0.9rem; margin-bottom: 0.1rem; line-height: 1; }
        html.is-dark .app-bar-stats .stat-item .heading { color: var(--dark-text-muted); }
        html.is-light-mode .app-bar-stats .stat-item .heading { color: var(--light-text-muted); }
        
        .app-bar-progress-container { width: 100%; padding: 0 0.25rem; }
        .app-bar-progress-container .progress { height: 0.5rem; margin-bottom: 0.2rem; }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-webkit-progress-value { background-color: var(--light-primary-accent); }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-moz-progress-bar { background-color: var(--light-primary-accent); }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-ms-fill { background-color: var(--light-primary-accent); }
        .app-bar-progress-container .progress-text { font-size: 0.6rem; text-align: center; line-height: 1;}
        html.is-dark .app-bar-progress-container .progress-text { color: #ccc; }
        html.is-light-mode .app-bar-progress-container .progress-text { color: var(--light-text-muted); }


        .page-title-bar { 
            padding: 0.5rem 1rem; text-align: center; font-size: 1.25rem; font-weight: bold;
        }
        html.is-dark .page-title-bar { background-color: var(--dark-card); border-bottom: 1px solid var(--dark-border); }
        html.is-light-mode .page-title-bar { background-color: var(--light-surface); border-bottom: 1px solid var(--light-border); }

        .content-area {
            flex-grow: 1; overflow-y: auto; padding: 1rem;
            margin-bottom: var(--nav-bar-height); animation: slideUpContent 0.6s ease-out;
            -webkit-overflow-scrolling: touch;
        }
        
        .task-message-list .message { cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .task-message-list .message:hover { transform: translateY(-3px); }
        html.is-dark .task-message-list .message { background-color: var(--dark-card); border-left: 4px solid var(--primary-color); }
        html.is-dark .task-message-list .message .message-header { background-color: var(--dark-surface); color: var(--dark-text); }
        html.is-dark .task-message-list .message .message-body { background-color: var(--dark-card); border-color: var(--dark-border); color: var(--dark-text-muted); }
        html.is-light-mode .task-message-list .message { border-left: 4px solid var(--light-primary-accent); }
        html.is-light-mode .task-message-list .message .message-header { background-color: var(--light-primary-accent); color: #fff; }
        html.is-light-mode .task-message-list .message .message-body { background-color: #fff; border-color: var(--light-border); color: var(--light-text-muted); }
        .task-message-list .message .message-body strong { color: var(--primary-color); } 
        html.is-light-mode .task-message-list .message .message-body strong { color: var(--light-success-accent); }
        .task-message-list .message.is-completed { border-left-color: var(--light-success-accent); } 
        html.is-dark .task-message-list .message.is-completed { border-left-color: #2ebf91; } 
        html.is-dark .task-message-list .message.is-completed .message-header { background-color: #2a523d; } 

        .progress-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 1.5rem; }
        .calendar-day { aspect-ratio: 1 / 1; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; }
        html.is-dark .calendar-day { background-color: var(--dark-card); border: 1px solid var(--dark-border); }
        html.is-light-mode .calendar-day { background-color: var(--light-card); border: 1px solid var(--light-border); }
        .calendar-day.is-completed { background-color: var(--primary-color) !important; color: white !important; }
        html.is-light-mode .calendar-day.is-completed { background-color: var(--light-success-accent) !important; }
        .calendar-day.is-future { opacity: 0.5; }
        html.is-dark .calendar-day.is-future { background-color: #222; }
        html.is-light-mode .calendar-day.is-future { background-color: #e9e9e9; }
        
        .chart-placeholder { height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; border-radius: 6px; }
        html.is-dark .chart-placeholder { background-color: var(--dark-card); border: 1px dashed var(--dark-border); }
        html.is-light-mode .chart-placeholder { background-color: var(--light-card); border: 1px dashed var(--light-border); }

        html.is-light-mode .button.is-primary { background-color: var(--light-primary-accent); border-color: transparent; }
        html.is-light-mode .button.is-primary:hover { background-color: var(--light-primary-accent-hover); }
        html.is-light-mode .button.is-success { background-color: var(--light-success-accent); border-color: transparent; }
        html.is-light-mode .input, html.is-light-mode .textarea, html.is-light-mode .select select { background-color: #fff; border-color: var(--light-border); color: var(--light-text); }
        html.is-light-mode .input::placeholder, html.is-light-mode .textarea::placeholder { color: var(--light-text-muted); }
        html.is-light-mode .box { background-color: var(--light-card); box-shadow: 0 2px 3px rgba(10,10,10,.04), 0 0 0 1px rgba(10,10,10,.04); }
        html.is-light-mode .label { color: #4a4a4a; }

        .task-done-checkbox-container { margin-top: 1rem; padding-top: 0.75rem; }
        html.is-dark .task-done-checkbox-container { border-top: 1px solid #444; }
        html.is-light-mode .task-done-checkbox-container { border-top: 1px solid #ddd; }
        .task-done-checkbox-label { display: flex; align-items: center; font-size: 0.9rem; }
        .task-done-checkbox-label .icon { margin-right: 0.5em; }
        html.is-dark .task-done-checkbox-label { color: var(--dark-text); }
        html.is-light-mode .task-done-checkbox-label { color: var(--light-text); }

        .nav-bar { height: var(--nav-bar-height); position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 0.3rem 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 100; animation: slideUp 0.5s ease-out; }
        html.is-dark .nav-bar { background-color: var(--dark-surface); }
        html.is-light-mode .nav-bar { background-color: var(--light-surface); box-shadow: 0 -2px 5px rgba(0,0,0,0.08); }
        .nav-bar .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; font-size: 0.65rem; padding: 0.2rem; border-radius: 8px; flex-grow: 1; text-align: center; transition: background-color 0.3s, color 0.3s, transform 0.2s; height: 100%; }
        html.is-dark .nav-bar .nav-item { color: #b0b0b0; }
        html.is-light-mode .nav-bar .nav-item { color: #7a7a7a; }
        .nav-bar .nav-item .icon { font-size: 1.2rem; margin-bottom: 0.1rem; }
        .nav-bar .nav-item.is-active { color: var(--primary-color); transform: translateY(-2px) scale(1.03); }
        html.is-light-mode .nav-bar .nav-item.is-active { color: var(--light-primary-accent); }
        html.is-dark .nav-bar .nav-item:hover { background-color: #3a3a3a; color: #fff; }
        html.is-light-mode .nav-bar .nav-item:hover { background-color: #e9e9e9; color: var(--light-text); }
        
        /* Settings Page Theme Toggle Switch */
        .theme-icons .icon { vertical-align: middle; }
        html.is-light-mode .switch.is-primary input[type=checkbox]:checked+.check { background-color: var(--light-primary-accent); }
        html.is-dark .switch.is-primary input[type=checkbox]:checked+.check { background-color: var(--primary-color); }
        html.is-dark .switch .control-label { color: var(--dark-text); }
        html.is-light-mode .switch .control-label { color: var(--light-text); }

        .modal .modal-card-body { max-height: 70vh; }
        .llm-chat-history { max-height: 200px; overflow-y: auto; border: 1px solid var(--dark-border); padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem;}
        html.is-light-mode .llm-chat-history { border-color: var(--light-border); }
        .llm-chat-history p { margin-bottom: 5px; }
        .llm-chat-history .user-message { text-align: right; }
        html.is-dark .llm-chat-history .user-message { color: #a1d9ff; }
        html.is-light-mode .llm-chat-history .user-message { color: var(--light-primary-accent); }
        .llm-chat-history .bot-message { text-align: left; }
        html.is-dark .llm-chat-history .bot-message { color: var(--dark-text); }
        html.is-light-mode .llm-chat-history .bot-message { color: var(--light-text); }

        .is-fullheight-with-fixed { min-height: calc(100vh - var(--app-bar-height) - var(--page-title-bar-height) - var(--nav-bar-height)); display: flex; flex-direction: column; justify-content: center; }
        .content-area.is-fullheight-no-title { min-height: calc(100vh - var(--app-bar-height) - var(--nav-bar-height)); display: flex; flex-direction: column; justify-content: center;}
        .form-page-container { width: 100%; max-width: 500px; margin: 0 auto; padding: 1rem; }
        .are-vertical .button:not(:last-child) { margin-bottom: 0.75rem !important; }
        
        html.is-dark .checkbox input[type="checkbox"] + span::before, html.is-dark .radio input[type="radio"] + span::before { border-color: #777; }
        html.is-dark .checkbox input[type="checkbox"]:checked + span::before, html.is-dark .radio input[type="radio"]:checked + span::before { background-color: var(--primary-color); border-color: var(--primary-color); }
        /* General switch background for dark mode when not checked */
        html.is-dark .switch input[type=checkbox]+.check { background: #555; }
        html.is-dark .label { color: #ccc; }
        html.is-dark .input, html.is-dark .textarea, html.is-dark .select select { background-color: #444; border-color: #555; color: var(--dark-text); }
        html.is-dark .input::placeholder, html.is-dark .textarea::placeholder { color: #888; }
        html.is-dark .box { background-color: var(--dark-card); }
        html.is-dark .notification.is-info.is-light { background-color: rgba(72, 199, 116, 0.1); color: #b8ebd0; }
        html.is-dark .notification.is-warning.is-light { background-color: rgba(255, 221, 87, 0.1); color: #ffe99a; }
        html.is-light-mode .notification.is-info.is-light { background-color: #e6f7ff; color: var(--light-primary-accent); border: 1px solid var(--light-primary-accent); }
        html.is-light-mode .notification.is-warning.is-light { background-color: #fffbeb; color: #947600; border: 1px solid #ffe58f;}

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes splashFadeOut { 0% { opacity: 1; visibility: visible; } 99% { opacity: 0; visibility: visible; } 100% { opacity: 0; visibility: hidden; } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideUpContent { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }
    </style>
</head>
<body>
    <!-- Universal App Bar -->
    <header class="app-bar" id="main-app-bar">
        <div class="app-bar-stats">
            <div class="stat-item"> <p class="heading">Points</p> <p class="title" id="app-bar-user-points">0</p> </div>
            <div class="stat-item"> <p class="heading">Streak</p> <p class="title" id="app-bar-user-streak">0d</p> </div>
        </div>
        <div class="app-bar-progress-container">
            <progress class="progress is-primary is-small" id="app-bar-challenge-progress-bar" value="0" max="70"></progress>
            <p class="progress-text" id="app-bar-challenge-progress-text">W1 D1</p>
        </div>
    </header>

    <div id="splash-page">
        <h1 class="title is-1">10 Weeks Up</h1> <h2 class="subtitle is-3">Your Transformation Journey.</h2>
        <progress class="progress is-small is-primary" max="100" style="width: 60%; margin-top: 20px;">15%</progress>
    </div>

    <div id="registration-page" class="page">
        <main class="content-area is-fullheight-no-title"> <div class="form-page-container"> <h1 class="title is-3 has-text-centered">Let's Get Started</h1> <p class="subtitle is-5 has-text-centered">Tell us a bit about yourself.</p> <form id="registration-form"> <div class="field"><label class="label">Name</label><div class="control"><input class="input" type="text" id="reg-name" placeholder="Your Name" required></div></div> <div class="field"><label class="label">Age</label><div class="control"><input class="input" type="number" id="reg-age" placeholder="e.g., 30" required min="16" max="99"></div></div> <div class="field"><label class="label">Gender</label><div class="control"><div class="select is-fullwidth"><select id="reg-gender" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div></div></div> <div class="field"><label class="label">Weight (kg)</label><div class="control"><input class="input" type="number" id="reg-weight" placeholder="e.g., 70" step="0.1" required></div></div> <div class="field"><label class="label">Height (cm)</label><div class="control"><input class="input" type="number" id="reg-height" placeholder="e.g., 175" required></div></div> <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Baseline</button> </form> </div> </main>
    </div>
    <div id="questionnaire-page" class="page">
        <main class="content-area is-fullheight-no-title"> <div class="form-page-container"> <h1 class="title is-3 has-text-centered">Your Starting Point</h1> <p class="subtitle is-5 has-text-centered">Record your initial performance.</p> <form id="baseline-form"> <div class="field"><label class="label">Cardio Capacity</label><div class="control"><input class="input" type="number" id="baseline-cardio" placeholder="e.g., 5 (mins) or 30 (reps)" required></div></div> <div class="field"><label class="label">Strength Reps</label><div class="control"><input class="input" type="number" id="baseline-strength" placeholder="e.g., 10" required></div></div> <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Choose Track</button> </form> </div> </main>
    </div>
    <div id="exercise-track-selection-page" class="page">
        <main class="content-area is-fullheight-no-title"> <div class="form-page-container"> <h1 class="title is-3 has-text-centered">Select Exercise Track</h1> <p class="subtitle is-5 has-text-centered">Pick one that suits you.</p> <div class="buttons are-medium is-centered are-vertical"> <button class="button is-info is-fullwidth" data-track="beginner">Beginner</button> <button class="button is-warning is-fullwidth" data-track="intermediate">Intermediate</button> <button class="button is-danger is-fullwidth" data-track="advanced">Advanced</button> </div> <p class="is-size-7 mt-4 has-text-centered">Routines escalate weekly.</p> </div> </main>
    </div>

    <div id="home-page" class="page">
        <div class="page-title-bar" id="home-page-title-bar">Daily Tasks</div>
        <main class="content-area">
             <button id="motivate-me-now-button-main" class="button is-primary is-fullwidth mb-3">Need a Boost? Motivate Me!</button>
            <div id="welcome-back-message" class="notification is-info is-light" style="display:none;"></div>
            <div id="daily-task-reminder" class="notification is-warning is-light mb-3" style="display:none;"> Don't forget your daily tasks! <button id="request-notification-permission" class="button is-small is-warning">Enable Reminders</button> </div>
            <div id="home-task-message-list" class="task-message-list"> <p class="has-text-centered">Loading daily tasks overview...</p> </div>
            <div class="content mt-4"> <h3 class="title is-4">Your Dashboard Info</h3> <div id="user-info-dashboard" class="box content is-small"></div> <div id="gamification-badges" class="box"> <h4 class="title is-5">My Badges</h4> <div id="badges-display" class="tags"></div> </div> </div>
        </main>
        <nav class="nav-bar"> <a href="#" class="nav-item is-active" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>

    <div id="sleep-task-page" class="page"> <div class="page-title-bar">Sleep Tracking</div> <main class="content-area" id="sleep-task-content"> <p>Sleep task details load here...</p> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav> </div>
    <div id="weight-task-page" class="page"> <div class="page-title-bar">Weight Control Log</div> <main class="content-area" id="weight-task-content"> <p>Weight task details load here...</p> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav> </div>
    <div id="exercise-task-page" class="page"> <div class="page-title-bar">Daily Exercise Routine</div> <main class="content-area" id="exercise-task-content"> <p>Exercise task details load here...</p> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav> </div>
    <div id="peace-task-page" class="page"> <div class="page-title-bar">Peace of Mind Tasks</div> <main class="content-area" id="peace-task-content"> <p>Peace task details load here...</p> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav> </div>

    <div id="motivate-page" class="page"> <div class="page-title-bar">Get Motivated</div> <main class="content-area"> <h1 class="title">Find Your Spark!</h1> <div id="educational-content-motivation" class="box content"><h4>Motivation?</h4><p>It's key!</p><h4>Habits?</h4><p>Repetition!</p></div> <div class="box"><p>"Quote 1"</p></div> <div class="box"><p>"Quote 2"</p></div> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item is-active" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav> </div>
    <div id="quit-page" class="page"> <div class="page-title-bar">Change a Habit</div> <main class="content-area"> <h1 class="title">Your Habit Focus</h1> <div id="quit-habit-content" class="box"></div> </main> <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item is-active" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav> </div>
    <div id="progress-page" class="page">
        <div class="page-title-bar">My Progress</div>
        <main class="content-area">
            <h2 class="title is-4">10 Week Challenge Calendar</h2> <div id="progress-calendar-grid" class="progress-calendar-grid"></div>
            <h2 class="title is-4 mt-5">Weight Journey (kg)</h2> <div id="weight-chart-placeholder" class="chart-placeholder">Chart Placeholder</div>
            <h2 class="title is-4 mt-5">Sleep Duration (hours)</h2> <div id="sleep-chart-placeholder" class="chart-placeholder">Chart Placeholder</div>
            <div class="box mt-5"> <h3 class="title is-5">Current Stats</h3> <p>Initial W: <span id="prog-initial-weight">N/A</span></p> <p>Logged W: <span id="prog-current-weight-display">N/A</span></p> <p>Target W: <span id="prog-target-weight">N/A</span></p> </div>
        </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item is-active" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>
    <div id="settings-page" class="page">
        <div class="page-title-bar">Settings</div>
        <main class="content-area"> <h1 class="title">App Settings</h1>
            <div class="field">
                <label class="label">Theme</label>
                <div class="control">
                    <label class="switch is-rounded is-primary" for="theme-toggle-checkbox">
                        <input type="checkbox" id="theme-toggle-checkbox">
                        <span class="check"></span>
                        <span class="control-label ml-2" id="theme-toggle-text">Dark Mode On</span>
                    </label>
                    <span class="theme-icons ml-2">
                        <span class="icon dark-icon-display"><i class="fas fa-moon"></i></span>
                        <span class="icon light-icon-display" style="display:none;"><i class="fas fa-sun"></i></span>
                    </span>
                </div>
            </div>
            <div class="field mt-4"><label class="label">Notifications</label><div class="control"><label class="switch is-rounded is-primary"><input type="checkbox" id="notifications-enabled-switch"><span class="check"></span><span class="control-label ml-2">Daily Reminders</span></label></div></div>
            <div class="field mt-5"><button class="button is-link is-fullwidth">My Account (Placeholder)</button></div>
            <div class="field mt-3"><button class="button is-outlined is-fullwidth" id="community-forum-link">Community Forum</button></div>
            <div class="field mt-3"><button id="reset-app-data" class="button is-danger is-fullwidth">Reset All App Data</button></div>
        </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item is-active" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>

    <div id="motivate-me-modal" class="modal"> <div class="modal-background"></div> <div class="modal-card"> <header class="modal-card-head"><p class="modal-card-title">Motivate Me Now!</p><button class="delete" aria-label="close"></button></header> <section class="modal-card-body"> <div class="field"><label class="label">Task?</label><div class="control"><div class="select is-fullwidth"><select id="motivation-task-select"><option value="general">General</option><option value="sleep">Sleep</option><option value="weight">Weight</option><option value="exercise">Exercise</option><option value="peace">Peace</option><option value="quitHabit">Habit</option></select></div></div></div> <div id="motivation-llm-response-area" class="content mt-4" style="display:none;"><h4 class="subtitle is-5">Pep Talk:</h4><p id="motivation-llm-text">Loading...</p></div> </section> <footer class="modal-card-foot"><button id="get-motivation-button" class="button is-success">Get Pep Talk</button><button class="button modal-close-button">Cancel</button></footer> </div> </div>
    <div id="llm-chat-modal" class="modal"> <div class="modal-background"></div> <div class="modal-card"> <header class="modal-card-head"><p class="modal-card-title">Talk About Stress Triggers</p><button class="delete" aria-label="close"></button></header> <section class="modal-card-body"> <p class="is-size-7 mb-2">Simulated chat.</p><div id="llm-chat-history-peace" class="llm-chat-history"></div><div class="field has-addons"><div class="control is-expanded"><input id="llm-chat-input-peace" class="input" type="text" placeholder="Tell me..."></div><div class="control"><button id="llm-chat-send-peace" class="button is-info">Send</button></div></div> </section> <footer class="modal-card-foot"><button class="button modal-close-button">Done</button></footer> </div> </div>

    <script>
        // --- Service Worer Registration ---
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').then(reg => console.log('SW registered.', reg)).catch(err => console.log('SW reg failed: ', err)); }); }

        document.addEventListener('DOMContentLoaded', () => {
            const mainAppBar = document.getElementById('main-app-bar');
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-bar .nav-item');
            const appBarUserPoints = document.getElementById('app-bar-user-points');
            const appBarUserStreak = document.getElementById('app-bar-user-streak');
            const appBarChallengeProgressBar = document.getElementById('app-bar-challenge-progress-bar');
            const appBarChallengeProgressText = document.getElementById('app-bar-challenge-progress-text');
            const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');
            const themeToggleText = document.getElementById('theme-toggle-text');
            const darkIconDisplay = document.querySelector('#settings-page .theme-icons .dark-icon-display');
            const lightIconDisplay = document.querySelector('#settings-page .theme-icons .light-icon-display');
            const motivateMeNowButtonMain = document.getElementById('motivate-me-now-button-main');
            const motivateMeModal = document.getElementById('motivate-me-modal');
            const llmChatModal = document.getElementById('llm-chat-modal');
            const homeTaskMessageList = document.getElementById('home-task-message-list');

            let appData = { user: null, baseline: null, dailyProgress: {}, weeklyGratitude: {}, gamification: { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null }, settings: { notificationsEnabled: false, theme: 'dark' }, habitChallenge: { behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null } };
            const TOTAL_WEEKS = 10; const DAYS_IN_WEEK = 7; const TOTAL_DAYS = TOTAL_WEEKS * DAYS_IN_WEEK;

            const getDayOfYear = (date = new Date()) => Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const saveAppData = () => { try { localStorage.setItem('transformationAppData', JSON.stringify(appData)); } catch (e) { console.error("LS Save Error:", e); }};
            const loadAppData = () => { 
                const data = localStorage.getItem('transformationAppData');
                if (data) {
                    try {
                        appData = JSON.parse(data);
                        appData.user = appData.user || null; appData.baseline = appData.baseline || null; appData.dailyProgress = appData.dailyProgress || {}; appData.weeklyGratitude = appData.weeklyGratitude || {};
                        appData.gamification = appData.gamification || { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null };
                        if(!appData.gamification.hasOwnProperty('lastWeightLog')) appData.gamification.lastWeightLog = null;
                        appData.settings = appData.settings || { notificationsEnabled: false, theme: 'dark' };
                        appData.habitChallenge = appData.habitChallenge || { behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null };
                    } catch (e) { console.error("LS Parse Error:", e); localStorage.removeItem('transformationAppData'); }
                }
            };

            const showPage = (pageId) => {
                pages.forEach(page => page.classList.remove('is-active'));
                const activePage = document.getElementById(pageId);

                const pagesWithoutAppBar = ['splash-page', 'registration-page', 'questionnaire-page', 'exercise-track-selection-page'];
                if (pagesWithoutAppBar.includes(pageId)) {
                    mainAppBar.classList.remove('is-visible');
                } else {
                    mainAppBar.classList.add('is-visible');
                }

                if (activePage) {
                    activePage.classList.add('is-active');
                    const pageTitleBarInPage = activePage.querySelector('.page-title-bar');
                    const contentAreaInPage = activePage.querySelector('.content-area');

                    if (contentAreaInPage) {
                        if (pagesWithoutAppBar.includes(pageId)) { 
                            if(pageTitleBarInPage) pageTitleBarInPage.style.marginTop = '0';
                            contentAreaInPage.style.marginTop = '0';
                        } else if (pageTitleBarInPage) { 
                            pageTitleBarInPage.style.marginTop = 'var(--app-bar-height)';
                            contentAreaInPage.style.marginTop = '0'; 
                        } else { 
                            contentAreaInPage.style.marginTop = 'var(--app-bar-height)';
                        }
                    }
                    if (pageTitleBarInPage && appData.user && pageId === 'home-page') {
                        pageTitleBarInPage.textContent = `Hi, ${appData.user.name}!`;
                    }
                }
                navItems.forEach(item => item.classList.toggle('is-active', item.dataset.page === pageId));
                window.scrollTo(0,0);
            };
            
            const calculateCurrentChallengeDay = () => { if (!appData.user || !appData.user.registrationDate) return { week: 1, day: 1, overallDay: 1 }; const regDate = new Date(appData.user.registrationDate); const today = new Date(); regDate.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffTime = Math.abs(today - regDate); const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); let overallDay = diffDays + 1; if (overallDay > TOTAL_DAYS) overallDay = TOTAL_DAYS; const currentWeek = Math.min(TOTAL_WEEKS, Math.floor((overallDay -1) / DAYS_IN_WEEK) + 1); const dayInWeek = ((overallDay -1) % DAYS_IN_WEEK) + 1; return { week: currentWeek, day: dayInWeek, overallDay: overallDay };};
            const getTodayProgressKey = () => { const { week, day } = calculateCurrentChallengeDay(); return `week${week}day${day}`; };
            const getProgressForToday = (createIfMissing = true) => {
                const key = getTodayProgressKey();
                if (!appData.dailyProgress[key] && createIfMissing) {
                    appData.dailyProgress[key] = {
                        sleep: { completed: false, bedtime: '', wakeup: '', duration: '', targetMet: null },
                        weight: { completed: false, meals: [], water: 0, foodLog: '', nonWater: '', junkAvoided: false, fruitSnacks: false, adheredMealTimes: false, calories: null },
                        exercise: { completed: false, cardioDone: false, strengthDone: false },
                        peace: { completed: false, mindfulnessDone: false, moodBefore: 3, stressBefore: 3, moodAfter: 3, stressAfter: 3, breathingDone: false, enjoyableActivityDone: false, llmChat: [] },
                        tasksCompletedCount: 0 
                    };
                }
                return appData.dailyProgress[key] || null;
            };

            const updateThemeMeta = (isLight) => { const rootStyle = getComputedStyle(document.documentElement); const themeColor = isLight ? rootStyle.getPropertyValue('--light-surface').trim() : rootStyle.getPropertyValue('--dark-surface').trim(); document.querySelector('meta[name="theme-color"]').setAttribute('content', themeColor || '#2c2c2c');};
            const applyTheme = (isLight) => { 
                document.documentElement.classList.toggle('is-light-mode', isLight); 
                document.documentElement.classList.toggle('is-dark', !isLight); 
                if (themeToggleCheckbox) themeToggleCheckbox.checked = isLight; 
                if (themeToggleText) themeToggleText.textContent = isLight ? "Light Mode On" : "Dark Mode On";
                if (darkIconDisplay) darkIconDisplay.style.display = isLight ? 'none' : 'inline-flex';
                if (lightIconDisplay) lightIconDisplay.style.display = isLight ? 'inline-flex' : 'none';
                appData.settings.theme = isLight ? 'light' : 'dark'; updateThemeMeta(isLight); saveAppData();
            };
            
            navItems.forEach(item => {item.addEventListener('click', (e) => {e.preventDefault(); const pageId = item.dataset.page; showPage(pageId); if (pageId === 'quit-page') renderQuitHabitPage(); if (pageId === 'progress-page') renderProgressPage();});});
            function setupModal(modalElement, openButtons, closeButtonsSelectors) { const openModal = () => modalElement.classList.add('is-active'); const closeModal = () => modalElement.classList.remove('is-active'); if (openButtons) { (Array.isArray(openButtons) ? openButtons : [openButtons]).forEach(btn => btn?.addEventListener('click', openModal)); } modalElement.querySelectorAll(closeButtonsSelectors).forEach(btn => btn.addEventListener('click', closeModal)); return { openModal, closeModal };}
            const motivateModalControls = setupModal(motivateMeModal, motivateMeNowButtonMain, '.modal-background, .delete, .modal-close-button');
            const llmChatModalControls = setupModal(llmChatModal, null, '.modal-background, .delete, .modal-close-button');

            const handleRegistration = (e) => { e.preventDefault(); const name = document.getElementById('reg-name').value; const age = parseInt(document.getElementById('reg-age').value); const gender = document.getElementById('reg-gender').value; const weight = parseFloat(document.getElementById('reg-weight').value); const height = parseInt(document.getElementById('reg-height').value); const heightM = height / 100; const idealBmiHealthy = 22; const idealWeight = Math.round(idealBmiHealthy * (heightM * heightM)); let bmr; if (gender === 'male') { bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age); } else if (gender === 'female') { bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age); } else { bmr = (88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age) + 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age)) / 2;} const caloricDeficit = 500; appData.user = { name, age, gender, weight, height, registrationDate: new Date().toISOString(), idealWeight, caloricDeficit, bmr: Math.round(bmr), exerciseTrack: null, currentDayOfYear: getDayOfYear(), lastLoginDayOfYear: getDayOfYear() }; appData.gamification = { points: 0, badges: [], dailyStreak: 0, lastWeightLog: { date: new Date().toISOString().split('T')[0], weight: weight } }; appData.dailyProgress = {}; appData.weeklyGratitude = {}; saveAppData(); showPage('questionnaire-page'); updateAppBarGamificationDisplay();};
            const handleBaseline = (e) => {  e.preventDefault(); appData.baseline = { cardioValue: parseInt(document.getElementById('baseline-cardio').value), strengthValue: parseInt(document.getElementById('baseline-strength').value) }; saveAppData(); showPage('exercise-track-selection-page');};
            const handleTrackSelection = (track) => { appData.user.exerciseTrack = track; saveAppData(); initializeAppDashboard(); };
            document.getElementById('registration-form')?.addEventListener('submit', handleRegistration);
            document.getElementById('baseline-form')?.addEventListener('submit', handleBaseline);
            document.querySelectorAll('#exercise-track-selection-page .button').forEach(btn => btn.addEventListener('click', () => handleTrackSelection(btn.dataset.track)));

            const requestNotificationPermission = async () => { if (!('Notification' in window)) { alert('Browser no support Notification'); return false; } if (Notification.permission === 'granted') return true; if (Notification.permission !== 'denied') { const permission = await Notification.requestPermission(); return permission === 'granted'; } return false; };
            const showDailyReminderNotification = () => { if (appData.settings.notificationsEnabled && Notification.permission === 'granted') { const { week, day } = calculateCurrentChallengeDay(); new Notification("Daily Tasks Reminder", { body: `Week ${week}, Day ${day}! Complete your 10 Week Up tasks!`, icon: 'icons/icon-192.png'});}};
            document.getElementById('request-notification-permission')?.addEventListener('click', async () => { const granted = await requestNotificationPermission(); if (granted) { appData.settings.notificationsEnabled = true; document.getElementById('notifications-enabled-switch').checked = true; new Notification('10 Week Transformation', { body: 'Notifications enabled!', icon: 'icons/icon-192.png' }); saveAppData(); }});
            document.getElementById('notifications-enabled-switch')?.addEventListener('change', async (e) => { appData.settings.notificationsEnabled = e.target.checked; if(e.target.checked) { const granted = await requestNotificationPermission(); if(!granted) { e.target.checked = false; appData.settings.notificationsEnabled = false; }} saveAppData();});

            const renderHomePageTaskMessages = () => {
                if (!homeTaskMessageList || !appData.user) { if(homeTaskMessageList) homeTaskMessageList.innerHTML = '<p>Please complete registration to see tasks.</p>'; return; }
                homeTaskMessageList.innerHTML = ''; 
                const todayProgress = getProgressForToday();
                const { week, day, overallDay } = calculateCurrentChallengeDay();

                if (overallDay > TOTAL_DAYS) {
                     homeTaskMessageList.innerHTML = `<article class="message is-success"><div class="message-body has-text-centered"><strong>Congratulations!</strong> You've completed the 10 Week Challenge!</div></article>`;
                     return;
                }

                const tasks = [
                    { id: 'sleep', name: 'Sleep Goals', icon: 'fa-bed', targetPage: 'sleep-task-page' },
                    { id: 'weight', name: 'Weight Control', icon: 'fa-balance-scale-right', targetPage: 'weight-task-page' },
                    { id: 'exercise', name: 'Daily Exercise', icon: 'fa-dumbbell', targetPage: 'exercise-task-page' },
                    { id: 'peace', name: 'Peace of Mind', icon: 'fa-brain', targetPage: 'peace-task-page' },
                    { id: 'habit', name: `Habit: ${appData.habitChallenge.behaviorName}`, icon: 'fa-route', targetPage: 'quit-page' }
                ];

                tasks.forEach(task => {
                    const isCompleted = (task.id === 'habit') ? (appData.habitChallenge.log[getTodayProgressKey()]?.completedToday || false) : (todayProgress[task.id]?.completed || false);
                    const statusText = isCompleted ? 'Complete' : 'Incomplete';
                    const messageClass = isCompleted ? 'is-success is-completed' : 'is-info';

                    const article = document.createElement('article'); article.className = `message ${messageClass} mb-3`; article.dataset.targetPage = task.targetPage; article.dataset.taskType = task.id;
                    const header = document.createElement('div'); header.className = 'message-header'; header.innerHTML = `<p><span class="icon is-small mr-1"><i class="fas ${task.icon}"></i></span>${task.name}</p>`;
                    const body = document.createElement('div'); body.className = 'message-body'; body.innerHTML = `Status: <strong>${statusText}</strong>. Tap to view/update.`;
                    article.appendChild(header); article.appendChild(body); homeTaskMessageList.appendChild(article);

                    article.addEventListener('click', () => {
                        if (task.id === 'sleep') renderSleepTaskPage(week,day,todayProgress.sleep);
                        else if (task.id === 'weight') renderWeightTaskPage(week,day,todayProgress.weight);
                        else if (task.id === 'exercise') renderExerciseTaskPage(week,day,todayProgress.exercise);
                        else if (task.id === 'peace') renderPeaceTaskPage(week,day,todayProgress.peace);
                        showPage(task.targetPage);
                    });
                });
            };

            // --- STUBBED Task Specific Page Rendering Functions ---
            function renderTaskPageContent(contentDivId, taskType, week, day, taskData, htmlGeneratorFunction, eventListenerSetupFunction) {
                const contentDiv = document.getElementById(contentDivId);
                if (!contentDiv) { console.error(`Content div ${contentDivId} not found.`); return; }
                contentDiv.innerHTML = ''; 
                let html = `<div class="box"><h3 class="title is-4">${taskType.charAt(0).toUpperCase() + taskType.slice(1)} Details</h3>`;
                html += htmlGeneratorFunction(week, day, taskData); // Call the specific HTML generator
                html += createTaskDoneCheckbox(taskType, taskData.completed, `Mark ${taskType} tasks as Complete?`);
                html += `</div>`;
                contentDiv.innerHTML = html;
                if (eventListenerSetupFunction) eventListenerSetupFunction();
            }

            function generateSleepHTML(week, day, sleepData) { /* Copy & adapt from old createSleepCard */ let c=''; if (week === 1) {c+=`<p>Week 1...</p><div class="field"><label class="label">Bedtime</label><input type="time" class="input sleep-input" data-field="bedtime" value="${sleepData.bedtime || ''}"></div>...`;} else {c+=`<p>Week 2+...</p>...`;} c+=`<p>Total Sleep: <strong id="sleep-duration-page">${sleepData.duration || 'N/A'}</strong></p>`; return c; }
            function renderSleepTaskPage(week,day,sleepData) { renderTaskPageContent('sleep-task-content', 'sleep', week, day, sleepData, generateSleepHTML, setupSleepTaskPageListeners); }
            function setupSleepTaskPageListeners() { /* Copy & adapt from old setupCardEventListeners for sleep inputs and overall checkbox */ document.querySelector('#sleep-task-page .task-overall-done-checkbox[data-tasktype="sleep"]')?.addEventListener('change', handleTaskOverallCompleteChange); /* ... other listeners ... */ }
            
            function generateWeightHTML(week, day, weightData) { /* Copy & adapt */ return `<p>Weight form fields go here for week ${week}...</p>`;}
            function renderWeightTaskPage(week,day,weightData) { renderTaskPageContent('weight-task-content', 'weight', week, day, weightData, generateWeightHTML, setupWeightTaskPageListeners); }
            function setupWeightTaskPageListeners() { /* Copy & adapt */ document.querySelector('#weight-task-page .task-overall-done-checkbox[data-tasktype="weight"]')?.addEventListener('change', handleTaskOverallCompleteChange); }

            function generateExerciseHTML(week, day, exerciseData) { /* Copy & adapt, use getExerciseRoutine */ const routine = getExerciseRoutine(appData.user.exerciseTrack, week, appData.user.gender, appData.user.age, appData.baseline); return `<p>Track: ${appData.user.exerciseTrack}</p><p>Cardio: ${routine.cardio}</p><p>Strength: ${routine.strength}</p>...checkboxes...`;}
            function renderExerciseTaskPage(week,day,exerciseData) { renderTaskPageContent('exercise-task-content', 'exercise', week, day, exerciseData, generateExerciseHTML, setupExerciseTaskPageListeners); }
            function setupExerciseTaskPageListeners() { /* Copy & adapt */ document.querySelector('#exercise-task-page .task-overall-done-checkbox[data-tasktype="exercise"]')?.addEventListener('change', handleTaskOverallCompleteChange); }

            function generatePeaceHTML(week, day, peaceData) { /* Copy & adapt */ return `<p>Mindfulness, mood sliders, etc. for week ${week}...</p>`;}
            function renderPeaceTaskPage(week,day,peaceData) { renderTaskPageContent('peace-task-content', 'peace', week, day, peaceData, generatePeaceHTML, setupPeaceTaskPageListeners); }
            function setupPeaceTaskPageListeners() { /* Copy & adapt, including mindfulness timer and LLM chat button */ document.querySelector('#peace-task-page .task-overall-done-checkbox[data-tasktype="peace"]')?.addEventListener('change', handleTaskOverallCompleteChange); document.getElementById('start-mindfulness-timer')?.addEventListener('click', startMindfulnessTimer); document.getElementById('open-llm-chat-peace')?.addEventListener('click', () => { const todayPeaceData = getProgressForToday().peace; peaceChatHistory = todayPeaceData.llmChat || []; renderLlmChatHistory('peace'); llmChatModalControls.openModal(); });}
            
            const handleTaskOverallCompleteChange = (e) => { const taskType = e.target.dataset.tasktype; const isChecked = e.target.checked; const icon = e.target.parentElement.querySelector('.icon i'); getProgressForToday()[taskType].completed = isChecked; if (isChecked) { icon.className = 'far fa-check-square'; addPoints(10); }  else { icon.className = 'far fa-square'; addPoints(-10); } checkAllDailyTasksCompletion(); updateAppBarGamificationDisplay(); saveAppData(); renderHomePageTaskMessages(); /* Refresh home list */ };
            const createTaskDoneCheckbox = (taskType, isChecked, labelText) => { const iconClass = isChecked ? 'fa-check-square' : 'fa-square'; return `<div class="task-done-checkbox-container"><label class="checkbox task-done-checkbox-label"><input type="checkbox" class="task-overall-done-checkbox" data-tasktype="${taskType}" ${isChecked ? 'checked' : ''}><span class="icon mr-1"><i class="far ${iconClass}"></i></span> ${labelText || 'Mark as Complete?'}</label></div>`; };
            const getExerciseRoutine = (track, week, gender, age, baseline) => { /* ... (same) ... */ return {cardio:"", strength:""}; }; // Full implementation needed

            function renderProgressCalendar() { /* ... (same as before) ... */ }
            let mindfulnessInterval; function startMindfulnessTimer() { /* ... (same) ... */ }
            function renderQuitHabitPage() { /* ... (same) ... */ }
            function renderProgressPage() { /* ... (same, calls renderProgressCalendar) ... */ }
            document.getElementById('save-prog-current-weight')?.addEventListener('click', () => { /* ... */ });

            const addPoints = (amount) => { appData.gamification.points = Math.max(0, appData.gamification.points + amount); };
            const awardBadge = (badgeName, badgeIconClass) => { /* ... (same) ... */ };
            const updateAppBarGamificationDisplay = () => { if (!appData.user || !appBarUserPoints) return; appBarUserPoints.textContent = appData.gamification.points; appBarUserStreak.textContent = `${appData.gamification.dailyStreak}d`; const { week, day, overallDay } = calculateCurrentChallengeDay(); appBarChallengeProgressBar.value = overallDay; appBarChallengeProgressBar.max = TOTAL_DAYS; appBarChallengeProgressText.textContent = `W${week} D${day}`; const badgesDisplay = document.getElementById('badges-display'); if(badgesDisplay) { badgesDisplay.innerHTML = ''; appData.gamification.badges.forEach(badge => { badgesDisplay.innerHTML += `<span class="tag is-medium is-success"><span class="icon is-small mr-1"><i class="${badge.icon}"></i></span>${badge.name}</span>`; });}};
            const checkAllDailyTasksCompletion = () => { /* ... (same, calls updateAppBarGamificationDisplay) ... */ };
            const checkAndAwardWeeklyBadges = (weekCompleted) => { /* ... (same, calls updateAppBarGamificationDisplay) ... */ };

            const getLLMSimulatedResponse = (type, input, context = null) => { /* ... (same) ... */ return new Promise(r => setTimeout(()=>r("Simulated LLM response."),100)); };
            document.getElementById('get-motivation-button')?.addEventListener('click', async () => { /* ... */ });
            let peaceChatHistory = []; const llmChatHistoryPeaceDiv = document.getElementById('llm-chat-history-peace'); const llmChatInputPeace = document.getElementById('llm-chat-input-peace');
            const renderLlmChatHistory = (contextType) => { /* ... (same) ... */ };
            document.getElementById('llm-chat-send-peace')?.addEventListener('click', async () => { /* ... */ });

            const initializeAppDashboard = () => {
                if (!appData.user) { showPage('registration-page'); return; }
                const homeTitleBar = document.getElementById('home-page-title-bar');
                if (homeTitleBar) homeTitleBar.textContent = `Hi, ${appData.user.name}!`;
                
                showPage('home-page'); 
                updateAppBarGamificationDisplay(); 

                const { week, day, overallDay } = calculateCurrentChallengeDay();
                appData.user.currentWeek = week;
                const todayOfYear = getDayOfYear();
                const welcomeMsgDiv = document.getElementById('welcome-back-message');
                if (appData.user.lastLoginDayOfYear) {
                    if (todayOfYear === appData.user.lastLoginDayOfYear) { welcomeMsgDiv.style.display = 'none'; } 
                    else if (todayOfYear === appData.user.lastLoginDayOfYear + 1) { welcomeMsgDiv.style.display = 'none'; } 
                    else { appData.gamification.dailyStreak = 0; welcomeMsgDiv.textContent = `Welcome back, ${appData.user.name}! Back on Week ${week}, Day ${day}.`; welcomeMsgDiv.style.display = 'block'; }
                }
                appData.user.lastLoginDayOfYear = todayOfYear;

                const userInfoDiv = document.getElementById('user-info-dashboard');
                if (userInfoDiv) { userInfoDiv.innerHTML = `<p><strong>Name:</strong> ${appData.user.name}</p><p><strong>Track:</strong> ${appData.user.exerciseTrack ? appData.user.exerciseTrack.charAt(0).toUpperCase() + appData.user.exerciseTrack.slice(1) : 'N/A'}</p><p><strong>Ideal W:</strong> ${appData.user.idealWeight} kg (BMR: ~${appData.user.bmr} kcal)</p>`;}
                
                renderHomePageTaskMessages(); 

                const todayProgressExists = getProgressForToday(false);
                const allTasksDoneToday = todayProgressExists ? Object.values(todayProgressExists).every(task => typeof task === 'object' ? task.completed : true) && appData.habitChallenge.log[getTodayProgressKey()]?.completedToday : false;
                const dailyReminderDiv = document.getElementById('daily-task-reminder');
                if (!allTasksDoneToday) { dailyReminderDiv.style.display = 'block'; showDailyReminderNotification(); } 
                else { dailyReminderDiv.style.display = 'none'; }
                saveAppData();
            };

            document.getElementById('reset-app-data')?.addEventListener('click', () => { if (confirm("Reset ALL app data?")) { localStorage.removeItem('transformationAppData'); appData = { user: null, baseline: null, dailyProgress: {}, weeklyGratitude: {}, gamification: { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null }, settings: { notificationsEnabled: false, theme: 'dark' }, habitChallenge: {behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null} }; location.reload(); }});
            document.getElementById('community-forum-link')?.addEventListener('click', () => { alert("Community Forum (Conceptual Link)"); });

            loadAppData();
            applyTheme(appData.settings.theme === 'light'); 
            if (themeToggleCheckbox) { themeToggleCheckbox.addEventListener('change', () => applyTheme(themeToggleCheckbox.checked)); }
            const notificationsSwitch = document.getElementById('notifications-enabled-switch');
            if(notificationsSwitch) notificationsSwitch.checked = appData.settings.notificationsEnabled;
            
            updateAppBarGamificationDisplay();

            const splashTimeout = (appData.user && appData.user.registrationDate) ? 1000 : 2600;
            setTimeout(() => {
                const splash = document.getElementById('splash-page');
                if (splash) splash.style.opacity = '0';
                setTimeout(() => {
                     if (splash) splash.style.display = 'none';
                     if (!appData.user) { showPage('registration-page'); } 
                     else if (!appData.baseline) { showPage('questionnaire-page'); } 
                     else if (!appData.user.exerciseTrack) { showPage('exercise-track-selection-page'); } 
                     else { initializeAppDashboard(); } 
                }, 500); 
            }, splashTimeout - 500);
        });
    </script>
</body>
</html>