<!DOCTYPE html>
<html lang="en" class="is-dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>10 Week Transformation</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2c2c2c">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="10Wk Up">
    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">
    <link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152.png">
    <link rel="apple-touch-icon" sizes="167x167" href="icons/apple-icon-167.png">
    <link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120.png">

    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* Dark Theme (Default) */
            --primary-color: #48c774; /* Bulma success green */
            --primary-color-light: #e6ffed; /* Light green for accents */
            --dark-bg: #1a1a1a;
            --dark-surface: #2c2c2c; /* App bars, nav bars */
            --dark-card: #333; /* Cards, boxes */
            --dark-text: #e0e0e0;
            --dark-text-muted: #999;
            --dark-border: #444;

            /* Light Theme - NEW PALETTE */
            --light-bg: #f0f2f5; /* Light bluish-gray background */
            --light-surface: #ffffff; /* White for app bars, nav bars */
            --light-card: #ffffff; /* White for cards, boxes */
            --light-text: #333a40; /* Dark cool gray for text */
            --light-text-muted: #777c80; /* Muted gray for less important text */
            --light-border: #dce1e6; /* Light border color */
            --light-primary-accent: #3d8bfd; /* A modern blue for primary actions */
            --light-primary-accent-hover: #2a72d7;
            --light-success-accent: #2ebf91; /* A tealish green for success states */


            --app-bar-height: 75px; 
            --nav-bar-height: 56px;
            --page-title-bar-height: 46px;
        }

        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }

        html.is-dark { background-color: var(--dark-bg); color: var(--dark-text); }
        html.is-light-mode { background-color: var(--light-bg); color: var(--light-text); }

        .page { display: none; flex-direction: column; height: 100vh; animation: fadeIn 0.5s ease-in-out; }
        .page.is-active { display: flex; }

        #splash-page { /* ... (Keep existing splash styles, ensure it matches theme) ... */
            display: flex; justify-content: center; align-items: center; flex-direction: column; height: 100vh; text-align: center; animation: splashFadeOut 2.5s ease-in-out forwards; animation-delay: 1s; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
        }
        html.is-dark #splash-page { background-color: var(--dark-surface); color: #fff;}
        html.is-light-mode #splash-page { background-color: var(--light-surface); color: var(--light-text);}
        #splash-page .title { font-size: 2.5rem; margin-bottom: 0.5em; animation: popIn 1s ease-out 0.2s forwards; opacity: 0; }
        #splash-page .subtitle { font-size: 1.25rem; animation: popIn 1s ease-out 0.5s forwards; opacity: 0; }


        .app-bar {
            display: none; /* Hidden by default, shown by JS */
            height: var(--app-bar-height); padding: 0.5rem 0.75rem; position: fixed; top: 0; left: 0; width: 100%;
            z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); animation: slideDown 0.5s ease-out;
            flex-direction: column; justify-content: space-around;
        }
        .app-bar.is-visible { display: flex; }
        html.is-dark .app-bar { background-color: var(--dark-surface); color: #fff; }
        html.is-light-mode .app-bar { background-color: var(--light-surface); color: var(--light-text); box-shadow: 0 2px 5px rgba(0,0,0,0.08); }

        .app-bar-stats { display: flex; justify-content: space-around; align-items: center; width: 100%; font-size: 0.75rem;}
        .app-bar-stats .stat-item { text-align: center; }
        .app-bar-stats .stat-item .heading { font-size: 0.6rem; margin-bottom: 0; text-transform: uppercase; }
        .app-bar-stats .stat-item .title { font-size: 0.9rem; margin-bottom: 0.1rem; line-height: 1; }
        html.is-dark .app-bar-stats .stat-item .heading { color: var(--dark-text-muted); }
        html.is-light-mode .app-bar-stats .stat-item .heading { color: var(--light-text-muted); }
        
        .app-bar-progress-container { width: 100%; padding: 0 0.25rem; }
        .app-bar-progress-container .progress { height: 0.5rem; margin-bottom: 0.2rem; }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-webkit-progress-value { background-color: var(--light-primary-accent); }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-moz-progress-bar { background-color: var(--light-primary-accent); }
        html.is-light-mode .app-bar-progress-container .progress.is-primary::-ms-fill { background-color: var(--light-primary-accent); }
        .app-bar-progress-container .progress-text { font-size: 0.6rem; text-align: center; line-height: 1;}
        html.is-dark .app-bar-progress-container .progress-text { color: #ccc; }
        html.is-light-mode .app-bar-progress-container .progress-text { color: var(--light-text-muted); }


        .page-title-bar { 
            padding: 0.5rem 1rem; text-align: center; font-size: 1.25rem; font-weight: bold;
            margin-top: var(--app-bar-height); /* Set if app bar is visible */
        }
        html.is-dark .page-title-bar { background-color: var(--dark-card); border-bottom: 1px solid var(--dark-border); }
        html.is-light-mode .page-title-bar { background-color: var(--light-surface); border-bottom: 1px solid var(--light-border); }

        .content-area {
            flex-grow: 1; overflow-y: auto; padding: 1rem;
            margin-bottom: var(--nav-bar-height); animation: slideUpContent 0.6s ease-out;
            -webkit-overflow-scrolling: touch;
            /* margin-top will be handled by showPage JS */
        }
        
        /* Home Page Task List (Messages) */
        .task-message-list .message { cursor: pointer; transition: transform 0.2s ease-out, box-shadow 0.2s ease-out; }
        .task-message-list .message:hover { transform: translateY(-3px); }
        html.is-dark .task-message-list .message { background-color: var(--dark-card); border-left: 4px solid var(--primary-color); }
        html.is-dark .task-message-list .message .message-header { background-color: var(--dark-surface); color: var(--dark-text); }
        html.is-dark .task-message-list .message .message-body { background-color: var(--dark-card); border-color: var(--dark-border); color: var(--dark-text-muted); }
        html.is-light-mode .task-message-list .message { border-left: 4px solid var(--light-primary-accent); }
        html.is-light-mode .task-message-list .message .message-header { background-color: var(--light-primary-accent); color: #fff; }
        html.is-light-mode .task-message-list .message .message-body { background-color: #fff; border-color: var(--light-border); color: var(--light-text-muted); }
        .task-message-list .message .message-body strong { color: var(--primary-color); } /* Default for dark */
        html.is-light-mode .task-message-list .message .message-body strong { color: var(--light-success-accent); }
        .task-message-list .message.is-completed { border-left-color: var(--light-success-accent); } /* For light theme */
        html.is-dark .task-message-list .message.is-completed { border-left-color: #2ebf91; } /* A slightly different green for dark theme completed */
        html.is-dark .task-message-list .message.is-completed .message-header { background-color: #2a523d; } /* Dark green for completed header */


        /* Progress Page Calendar & Charts */
        .progress-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 1.5rem; }
        .calendar-day { 
            aspect-ratio: 1 / 1; border-radius: 4px; display: flex; align-items: center; justify-content: center; 
            font-size: 0.7rem;
        }
        html.is-dark .calendar-day { background-color: var(--dark-card); border: 1px solid var(--dark-border); }
        html.is-light-mode .calendar-day { background-color: var(--light-card); border: 1px solid var(--light-border); }
        .calendar-day.is-completed { background-color: var(--primary-color) !important; color: white !important; }
        html.is-light-mode .calendar-day.is-completed { background-color: var(--light-success-accent) !important; }
        .calendar-day.is-future { opacity: 0.5; }
        html.is-dark .calendar-day.is-future { background-color: #222; }
        html.is-light-mode .calendar-day.is-future { background-color: #e9e9e9; }
        
        .chart-placeholder { height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; border-radius: 6px; }
        html.is-dark .chart-placeholder { background-color: var(--dark-card); border: 1px dashed var(--dark-border); }
        html.is-light-mode .chart-placeholder { background-color: var(--light-card); border: 1px dashed var(--light-border); }

        /* Other existing styles from previous steps - card, nav-bar, form, modal, theme-toggle etc. */
        /* Ensure light theme variables are applied to buttons, inputs, etc. */
        html.is-light-mode .button.is-primary { background-color: var(--light-primary-accent); border-color: transparent; }
        html.is-light-mode .button.is-primary:hover { background-color: var(--light-primary-accent-hover); }
        html.is-light-mode .button.is-success { background-color: var(--light-success-accent); border-color: transparent; }
        html.is-light-mode .input, html.is-light-mode .textarea, html.is-light-mode .select select {
            background-color: #fff; border-color: var(--light-border); color: var(--light-text);
        }
        html.is-light-mode .input::placeholder, html.is-light-mode .textarea::placeholder { color: var(--light-text-muted); }
        html.is-light-mode .box { background-color: var(--light-card); box-shadow: 0 2px 3px rgba(10,10,10,.04), 0 0 0 1px rgba(10,10,10,.04); }
        html.is-light-mode .label { color: #4a4a4a; /* Standard Bulma label color */ }

        /* Remaining styles from previous response (card, nav-bar, modal specifics etc.) */
        .card-collection-container { position: relative; margin-top: 0.5rem; }
        .card-collection { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 1rem; -webkit-overflow-scrolling: touch; }
        .card-collection .card { flex: 0 0 auto; width: 85vw; max-width: 320px; margin-right: 1rem; margin-bottom: 1rem; scroll-snap-align: start; border-radius: 10px; transition: transform 0.3s ease-out, background-color 0.3s ease-in-out, opacity 0.3s ease-in-out; position: relative; }
        html.is-dark .card-collection .card { background-color: var(--dark-card); color: var(--dark-text); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        html.is-light-mode .card-collection .card { background-color: var(--light-card); color: var(--light-text); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card-collection .card:hover:not(.is-task-done) { transform: translateY(-5px); }
        .card-collection .card .card-content { padding: 1rem; }
        .card-collection .card .title { font-size: 1.1rem; margin-bottom: 0.5rem;}
        .card-collection .card .subtitle { font-size: 0.85rem; margin-bottom: 0.75rem;}
        html.is-dark .card-collection .card .title, html.is-dark .card-collection .card .subtitle { color: var(--dark-text); }
        html.is-light-mode .card-collection .card .title, html.is-light-mode .card-collection .card .subtitle { color: var(--light-text); }
        .card .label { font-size: 0.9rem; margin-bottom: 0.3rem; }
        .card .input, .card .select select, .card .textarea { font-size: 0.9rem; margin-bottom: 0.5rem; }
        .card .button { font-size: 0.9rem; }
        .card .field:not(:last-child) { margin-bottom: 0.75rem; }
        .card.is-task-done { opacity: 0.85; }
        html.is-dark .card.is-task-done { background-color: #2a523d; border-left: 5px solid var(--primary-color); }
        html.is-light-mode .card.is-task-done { background-color: var(--primary-color-light); border-left: 5px solid var(--primary-color); }
        .card.is-task-done .title, .card.is-task-done .subtitle, .card.is-task-done p:not(.task-done-checkbox-label span) { color: #c0c0c0; }
        html.is-light-mode .card.is-task-done .title, html.is-light-mode .card.is-task-done .subtitle, html.is-light-mode .card.is-task-done p:not(.task-done-checkbox-label span) { color: #555; }
        .card.is-task-done .task-done-checkbox-label { color: var(--dark-text) !important; }
        html.is-light-mode .card.is-task-done .task-done-checkbox-label { color: var(--light-text) !important; }
        .task-done-checkbox-container { margin-top: 1rem; padding-top: 0.75rem; }
        html.is-dark .task-done-checkbox-container { border-top: 1px solid #444; }
        html.is-light-mode .task-done-checkbox-container { border-top: 1px solid #ddd; }
        .task-done-checkbox-label { display: flex; align-items: center; font-size: 0.9rem; }
        .task-done-checkbox-label .icon { margin-right: 0.5em; }
        html.is-dark .task-done-checkbox-label { color: var(--dark-text); }
        html.is-light-mode .task-done-checkbox-label { color: var(--light-text); }
        .card.is-disappearing { transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, height 0.4s ease-in-out 0.1s, margin 0.4s ease-in-out 0.1s, padding 0.4s ease-in-out 0.1s; transform: translateY(-80px) scale(0.8) rotateX(30deg); opacity: 0 !important; height: 0 !important; margin: 0 !important; padding: 0 !important; overflow: hidden; pointer-events: none; }

        .nav-bar { height: var(--nav-bar-height); position: fixed; bottom: 0; left: 0; width: 100%; display: flex; justify-content: space-around; padding: 0.3rem 0; box-shadow: 0 -2px 5px rgba(0,0,0,0.2); z-index: 100; animation: slideUp 0.5s ease-out; }
        html.is-dark .nav-bar { background-color: var(--dark-surface); }
        html.is-light-mode .nav-bar { background-color: var(--light-surface); box-shadow: 0 -2px 5px rgba(0,0,0,0.08); }
        .nav-bar .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; font-size: 0.65rem; padding: 0.2rem; border-radius: 8px; flex-grow: 1; text-align: center; transition: background-color 0.3s, color 0.3s, transform 0.2s; height: 100%; }
        html.is-dark .nav-bar .nav-item { color: #b0b0b0; }
        html.is-light-mode .nav-bar .nav-item { color: #7a7a7a; }
        .nav-bar .nav-item .icon { font-size: 1.2rem; margin-bottom: 0.1rem; }
        .nav-bar .nav-item.is-active { color: var(--primary-color); transform: translateY(-2px) scale(1.03); }
        html.is-light-mode .nav-bar .nav-item.is-active { color: var(--light-primary-accent); }
        html.is-dark .nav-bar .nav-item:hover { background-color: #3a3a3a; color: #fff; }
        html.is-light-mode .nav-bar .nav-item:hover { background-color: #e9e9e9; color: var(--light-text); }

        .theme-toggle-label { display: flex; align-items: center; cursor: pointer; padding: 0.5rem; border-radius: 4px; transition: background-color 0.2s; }
        html.is-dark .theme-toggle-label:hover { background-color: rgba(255,255,255,0.1); }
        html.is-light-mode .theme-toggle-label:hover { background-color: rgba(0,0,0,0.05); }
        .theme-toggle-label input[type="checkbox"] { opacity: 0; width: 0; height: 0; position: absolute; }
        .theme-toggle-icon-container { display: inline-flex; align-items: center; }
        
        .modal .modal-card-body { max-height: 70vh; }
        .llm-chat-history { max-height: 200px; overflow-y: auto; border: 1px solid var(--dark-border); padding: 10px; margin-bottom: 10px; border-radius: 4px; font-size: 0.9rem;}
        html.is-light-mode .llm-chat-history { border-color: var(--light-border); }
        .llm-chat-history p { margin-bottom: 5px; }
        .llm-chat-history .user-message { text-align: right; }
        html.is-dark .llm-chat-history .user-message { color: #a1d9ff; }
        html.is-light-mode .llm-chat-history .user-message { color: var(--light-primary-accent); }
        .llm-chat-history .bot-message { text-align: left; }
        html.is-dark .llm-chat-history .bot-message { color: var(--dark-text); }
        html.is-light-mode .llm-chat-history .bot-message { color: var(--light-text); }

        .user-stats { margin-bottom: 1rem; }
        .user-stats .tag { margin-right: 0.5rem; }
        
        .is-fullheight-with-fixed { min-height: calc(100vh - var(--app-bar-height) - var(--page-title-bar-height) - var(--nav-bar-height)); display: flex; flex-direction: column; justify-content: center; }
        .content-area.is-fullheight-no-title { min-height: calc(100vh - var(--app-bar-height) - var(--nav-bar-height)); display: flex; flex-direction: column; justify-content: center;}
        .form-page-container { width: 100%; max-width: 500px; margin: 0 auto; padding: 1rem; }
        .are-vertical .button:not(:last-child) { margin-bottom: 0.75rem !important; }
        
        html.is-dark .checkbox input[type="checkbox"] + span::before, html.is-dark .radio input[type="radio"] + span::before { border-color: #777; }
        html.is-dark .checkbox input[type="checkbox"]:checked + span::before, html.is-dark .radio input[type="radio"]:checked + span::before { background-color: var(--primary-color); border-color: var(--primary-color); }
        html.is-dark .switch input[type=checkbox]+.check { background: #555; }
        html.is-dark .switch input[type=checkbox]:checked+.check { background: var(--primary-color); }
        html.is-dark .label { color: #ccc; }
        html.is-dark .input, html.is-dark .textarea, html.is-dark .select select { background-color: #444; border-color: #555; color: var(--dark-text); }
        html.is-dark .input::placeholder, html.is-dark .textarea::placeholder { color: #888; }
        html.is-dark .box { background-color: var(--dark-card); }
        html.is-dark .notification.is-info.is-light { background-color: rgba(72, 199, 116, 0.1); color: #b8ebd0; }
        html.is-dark .notification.is-warning.is-light { background-color: rgba(255, 221, 87, 0.1); color: #ffe99a; }
        html.is-light-mode .notification.is-info.is-light { background-color: #e6f7ff; color: var(--light-primary-accent); border: 1px solid var(--light-primary-accent); }
        html.is-light-mode .notification.is-warning.is-light { background-color: #fffbeb; color: #947600; border: 1px solid #ffe58f;}

        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        @keyframes popIn { 0% { opacity: 0; transform: scale(0.5); } 100% { opacity: 1; transform: scale(1); } }
        @keyframes splashFadeOut { 0% { opacity: 1; visibility: visible; } 99% { opacity: 0; visibility: visible; } 100% { opacity: 0; visibility: hidden; } }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(0); } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideUpContent { from { opacity:0; transform: translateY(20px); } to { opacity:1; transform: translateY(0); } }

    </style>
</head>
<body>
    <!-- Universal App Bar -->
    <header class="app-bar" id="main-app-bar"> <!-- Added ID -->
        <div class="app-bar-stats">
            <div class="stat-item">
                <p class="heading">Points</p>
                <p class="title" id="app-bar-user-points">0</p>
            </div>
            <div class="stat-item">
                <p class="heading">Streak</p>
                <p class="title" id="app-bar-user-streak">0d</p>
            </div>
        </div>
        <div class="app-bar-progress-container">
            <progress class="progress is-primary is-small" id="app-bar-challenge-progress-bar" value="0" max="70"></progress>
            <p class="progress-text" id="app-bar-challenge-progress-text">W1 D1</p>
        </div>
    </header>

    <div id="splash-page"> <!-- Splash does not have app bar visible -->
        <h1 class="title is-1">10 Weeks Up</h1>
        <h2 class="subtitle is-3">Your Transformation Journey.</h2>
        <progress class="progress is-small is-primary" max="100" style="width: 60%; margin-top: 20px;">15%</progress>
    </div>

    <!-- Registration Page -->
    <div id="registration-page" class="page">
        <main class="content-area is-fullheight-no-title">
            <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Let's Get Started</h1>
                <p class="subtitle is-5 has-text-centered">Tell us a bit about yourself.</p>
                <form id="registration-form">
                    <div class="field"><label class="label">Name</label><div class="control"><input class="input" type="text" id="reg-name" placeholder="Your Name" required></div></div>
                    <div class="field"><label class="label">Age</label><div class="control"><input class="input" type="number" id="reg-age" placeholder="e.g., 30" required min="16" max="99"></div></div>
                    <div class="field"><label class="label">Gender</label><div class="control"><div class="select is-fullwidth"><select id="reg-gender" required><option value="">Select Gender</option><option value="male">Male</option><option value="female">Female</option><option value="other">Other</option></select></div></div></div>
                    <div class="field"><label class="label">Weight (kg)</label><div class="control"><input class="input" type="number" id="reg-weight" placeholder="e.g., 70" step="0.1" required></div></div>
                    <div class="field"><label class="label">Height (cm)</label><div class="control"><input class="input" type="number" id="reg-height" placeholder="e.g., 175" required></div></div>
                    <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Baseline</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Questionnaire/Baseline Page -->
    <div id="questionnaire-page" class="page">
        <main class="content-area is-fullheight-no-title">
             <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Your Starting Point</h1>
                <p class="subtitle is-5 has-text-centered">Record your initial performance.</p>
                <form id="baseline-form">
                    <div class="field"><label class="label">Cardio Capacity (e.g., Mins of continuous jogging, or reps in 1 min jump test)</label><div class="control"><input class="input" type="number" id="baseline-cardio" placeholder="e.g., 5 (mins) or 30 (reps)" required></div></div>
                    <div class="field"><label class="label">Strength Reps (e.g., Max push-ups or squats)</label><div class="control"><input class="input" type="number" id="baseline-strength" placeholder="e.g., 10" required></div></div>
                    <button type="submit" class="button is-primary is-fullwidth mt-5">Next: Choose Track</button>
                </form>
            </div>
        </main>
    </div>

    <!-- Exercise Track Selection Page -->
    <div id="exercise-track-selection-page" class="page">
        <main class="content-area is-fullheight-no-title">
            <div class="form-page-container">
                <h1 class="title is-3 has-text-centered">Select Exercise Track</h1>
                <p class="subtitle is-5 has-text-centered">Pick a track that suits your current fitness level.</p>
                <div class="buttons are-medium is-centered are-vertical">
                    <button class="button is-info is-fullwidth" data-track="beginner">Beginner Track</button>
                    <button class="button is-warning is-fullwidth" data-track="intermediate">Intermediate Track</button>
                    <button class="button is-danger is-fullwidth" data-track="advanced">Advanced Track</button>
                </div>
                <p class="is-size-7 mt-4 has-text-centered">Tracks will escalate weekly based on your baseline, age, and gender.</p>
            </div>
        </main>
    </div>

    <!-- Home Page (Dashboard) -->
    <div id="home-page" class="page">
        <div class="page-title-bar" id="home-page-title-bar">Daily Tasks</div>
        <main class="content-area">
             <button id="motivate-me-now-button-main" class="button is-primary is-fullwidth mb-3">Need a Boost? Motivate Me!</button>
            <div id="welcome-back-message" class="notification is-info is-light" style="display:none;"></div>
            <div id="daily-task-reminder" class="notification is-warning is-light mb-3" style="display:none;">
                Don't forget your daily tasks! <button id="request-notification-permission" class="button is-small is-warning">Enable Reminders</button>
            </div>
            
            <div id="home-task-message-list" class="task-message-list">
                <!-- Task messages will be injected here by JS -->
                <p class="has-text-centered">Loading daily tasks overview...</p>
            </div>

             <div class="content mt-4">
                <h3 class="title is-4">Your Dashboard Info</h3>
                <div id="user-info-dashboard" class="box content is-small"></div>
                <div id="gamification-badges" class="box">
                    <h4 class="title is-5">My Badges</h4>
                    <div id="badges-display" class="tags"></div>
                </div>
            </div>
        </main>
        <nav class="nav-bar">
            <a href="#" class="nav-item is-active" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a>
            <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a>
            <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a>
            <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a>
            <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a>
        </nav>
    </div>

    <!-- NEW Task Specific Pages -->
    <div id="sleep-task-page" class="page">
        <div class="page-title-bar">Sleep Tracking</div>
        <main class="content-area" id="sleep-task-content"> <!-- Content will be injected here --> </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav>
    </div>
    <div id="weight-task-page" class="page">
        <div class="page-title-bar">Weight Control Log</div>
        <main class="content-area" id="weight-task-content"></main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav>
    </div>
    <div id="exercise-task-page" class="page">
        <div class="page-title-bar">Daily Exercise Routine</div>
        <main class="content-area" id="exercise-task-content"></main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav>
    </div>
    <div id="peace-task-page" class="page">
        <div class="page-title-bar">Peace of Mind Tasks</div>
        <main class="content-area" id="peace-task-content"></main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-arrow-left"></i></span>Back</a> </nav>
    </div>
    <!-- Note: "Habit" page already exists and can be considered a task page -->


    <!-- Motivate Page -->
    <div id="motivate-page" class="page">
        <div class="page-title-bar">Get Motivated</div>
        <main class="content-area"> <h1 class="title">Find Your Spark!</h1> <div id="educational-content-motivation" class="box content"><h4>Why is motivation important?</h4><p>Motivation is the driving force...</p><h4>How habit formation works:</h4><p>Habits are formed through repetition...</p></div> <div class="box"><p class="is-size-5 has-text-centered">"The journey of a thousand miles begins with a single step." - Lao Tzu</p></div> <div class="box"><p class="is-size-5 has-text-centered">"Success is not final, failure is not fatal: It is the courage to continue that counts." - Winston Churchill</p></div> </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item is-active" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>

    <!-- Quit Habit Page -->
    <div id="quit-page" class="page">
        <div class="page-title-bar">Change a Habit</div>
        <main class="content-area"> <h1 class="title">Your Habit Focus</h1> <div id="quit-habit-content" class="box"></div> </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item is-active" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>
    
    <!-- My Progress Page -->
    <div id="progress-page" class="page">
        <div class="page-title-bar">My Progress</div>
        <main class="content-area">
            <h2 class="title is-4">10 Week Challenge Calendar</h2>
            <div id="progress-calendar-grid" class="progress-calendar-grid">
                <!-- Calendar days will be injected here -->
            </div>

            <h2 class="title is-4 mt-5">Weight Journey (kg)</h2>
            <div id="weight-chart-placeholder" class="chart-placeholder">Chart Placeholder - Weight vs. Time</div>
            
            <h2 class="title is-4 mt-5">Sleep Duration (hours)</h2>
            <div id="sleep-chart-placeholder" class="chart-placeholder">Chart Placeholder - Sleep vs. Time</div>

            <div class="box mt-5">
                <h3 class="title is-5">Current Stats</h3>
                <p>Initial Weight: <span id="prog-initial-weight" class="has-text-weight-bold">N/A</span> kg</p>
                <p>Logged Weight: <span id="prog-current-weight-display" class="has-text-weight-bold">N/A</span> kg</p>
                <p>Target Ideal Weight: <span id="prog-target-weight" class="has-text-weight-bold">N/A</span> kg</p>
            </div>
        </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item is-active" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>

    <!-- Settings Page -->
    <div id="settings-page" class="page">
        <div class="page-title-bar">Settings</div>
        <main class="content-area"> <h1 class="title">App Settings</h1> <div class="field"><label class="label">Theme</label><div class="control"><label class="theme-toggle-label" for="theme-toggle-checkbox"><input type="checkbox" id="theme-toggle-checkbox"><span class="theme-toggle-icon-container"><span class="icon dark-icon"><i class="fas fa-moon"></i></span><span class="icon light-icon" style="display:none;"><i class="fas fa-sun"></i></span></span><span id="theme-toggle-text" class="ml-2">Toggle</span></label></div></div> <div class="field mt-4"><label class="label">Notifications</label><div class="control"><label class="switch is-rounded is-primary"><input type="checkbox" id="notifications-enabled-switch"><span class="check"></span><span class="control-label ml-2">Daily Reminders</span></label></div></div> <div class="field mt-5"><button class="button is-link is-fullwidth">My Account (Placeholder)</button></div> <div class="field mt-3"><button class="button is-outlined is-fullwidth" id="community-forum-link">Community Forum (Link)</button></div> <div class="field mt-3"><button id="reset-app-data" class="button is-danger is-fullwidth">Reset All App Data</button></div> </main>
        <nav class="nav-bar"> <a href="#" class="nav-item" data-page="home-page"><span class="icon"><i class="fas fa-home"></i></span>Home</a> <a href="#" class="nav-item" data-page="motivate-page"><span class="icon"><i class="fas fa-lightbulb"></i></span>Motivate</a> <a href="#" class="nav-item" data-page="quit-page"><span class="icon"><i class="fas fa-ban"></i></span>Habit</a> <a href="#" class="nav-item" data-page="progress-page"><span class="icon"><i class="fas fa-chart-line"></i></span>Progress</a> <a href="#" class="nav-item is-active" data-page="settings-page"><span class="icon"><i class="fas fa-cog"></i></span>Settings</a> </nav>
    </div>

    <!-- Modals (same as before) -->
    <div id="motivate-me-modal" class="modal"> <div class="modal-background"></div> <div class="modal-card"> <header class="modal-card-head"><p class="modal-card-title">Motivate Me Now!</p><button class="delete" aria-label="close"></button></header> <section class="modal-card-body"> <div class="field"><label class="label">Task you need motivation for?</label><div class="control"><div class="select is-fullwidth"><select id="motivation-task-select"><option value="general">General</option><option value="sleep">Sleep</option><option value="weight">Weight</option><option value="exercise">Exercise</option><option value="peace">Peace</option><option value="quitHabit">Habit</option></select></div></div></div> <div id="motivation-llm-response-area" class="content mt-4" style="display:none;"><h4 class="subtitle is-5">Pep Talk:</h4><p id="motivation-llm-text">Loading...</p></div> </section> <footer class="modal-card-foot"><button id="get-motivation-button" class="button is-success">Get Pep Talk</button><button class="button modal-close-button">Cancel</button></footer> </div> </div>
    <div id="llm-chat-modal" class="modal"> <div class="modal-background"></div> <div class="modal-card"> <header class="modal-card-head"><p class="modal-card-title">Talk About Stress Triggers</p><button class="delete" aria-label="close"></button></header> <section class="modal-card-body"> <p class="is-size-7 mb-2">Simulated chat. Responses are pre-defined.</p><div id="llm-chat-history-peace" class="llm-chat-history"></div><div class="field has-addons"><div class="control is-expanded"><input id="llm-chat-input-peace" class="input" type="text" placeholder="Tell me about a stress trigger..."></div><div class="control"><button id="llm-chat-send-peace" class="button is-info">Send</button></div></div> </section> <footer class="modal-card-foot"><button class="button modal-close-button">Done</button></footer> </div> </div>

    <script>
        // --- Service Worker Registration ---
        if ('serviceWorker' in navigator) { /* ... */ }

        document.addEventListener('DOMContentLoaded', () => {
            const mainAppBar = document.getElementById('main-app-bar');
            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-bar .nav-item');
            const appBarUserPoints = document.getElementById('app-bar-user-points');
            const appBarUserStreak = document.getElementById('app-bar-user-streak');
            const appBarChallengeProgressBar = document.getElementById('app-bar-challenge-progress-bar');
            const appBarChallengeProgressText = document.getElementById('app-bar-challenge-progress-text');
            const themeToggleCheckbox = document.getElementById('theme-toggle-checkbox');
            const motivateMeNowButtonMain = document.getElementById('motivate-me-now-button-main');
            const motivateMeModal = document.getElementById('motivate-me-modal');
            const llmChatModal = document.getElementById('llm-chat-modal');
            const homeTaskMessageList = document.getElementById('home-task-message-list');


            let appData = { user: null, baseline: null, dailyProgress: {}, weeklyGratitude: {}, gamification: { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null }, settings: { notificationsEnabled: false, theme: 'dark' }, habitChallenge: { behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null } };
            const TOTAL_WEEKS = 10; const DAYS_IN_WEEK = 7; const TOTAL_DAYS = TOTAL_WEEKS * DAYS_IN_WEEK;

            const getDayOfYear = (date = new Date()) => Math.floor((date - new Date(date.getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const saveAppData = () => { try { localStorage.setItem('transformationAppData', JSON.stringify(appData)); } catch (e) { console.error("LS Save Error:", e); }};
            const loadAppData = () => { 
                const data = localStorage.getItem('transformationAppData');
                if (data) {
                    try {
                        appData = JSON.parse(data);
                        appData.user = appData.user || null; appData.baseline = appData.baseline || null; appData.dailyProgress = appData.dailyProgress || {}; appData.weeklyGratitude = appData.weeklyGratitude || {};
                        appData.gamification = appData.gamification || { points: 0, badges: [], dailyStreak: 0, lastWeightLog: null };
                        if(!appData.gamification.hasOwnProperty('lastWeightLog')) appData.gamification.lastWeightLog = null;
                        appData.settings = appData.settings || { notificationsEnabled: false, theme: 'dark' };
                        appData.habitChallenge = appData.habitChallenge || { behaviorName: "My Unwanted Habit", log: {}, trigger: null, substitution: null };
                    } catch (e) { console.error("LS Parse Error:", e); localStorage.removeItem('transformationAppData'); }
                }
            };

            const showPage = (pageId) => {
                console.log("Attempting to show page:", pageId);
                pages.forEach(page => page.classList.remove('is-active'));
                const activePage = document.getElementById(pageId);

                // Conditional App Bar Visibility
                const pagesWithoutAppBar = ['splash-page', 'registration-page', 'questionnaire-page', 'exercise-track-selection-page'];
                if (pagesWithoutAppBar.includes(pageId)) {
                    mainAppBar.classList.remove('is-visible');
                } else {
                    mainAppBar.classList.add('is-visible');
                }

                if (activePage) {
                    activePage.classList.add('is-active');
                    const pageTitleBarInPage = activePage.querySelector('.page-title-bar');
                    const contentAreaInPage = activePage.querySelector('.content-area');

                    if (contentAreaInPage) {
                        if (pagesWithoutAppBar.includes(pageId)) { // No app bar, so no offset needed from it for title or content
                            if(pageTitleBarInPage) pageTitleBarInPage.style.marginTop = '0';
                            contentAreaInPage.style.marginTop = '0';
                        } else if (pageTitleBarInPage) { // App bar IS visible, and this page HAS a title bar
                            pageTitleBarInPage.style.marginTop = 'var(--app-bar-height)';
                            contentAreaInPage.style.marginTop = '0'; // Content is below page title bar
                        } else { // App bar IS visible, but page has NO title bar (e.g. a direct task page)
                            contentAreaInPage.style.marginTop = 'var(--app-bar-height)';
                        }
                    }

                    if (pageTitleBarInPage && appData.user && pageId === 'home-page') {
                        pageTitleBarInPage.textContent = `Hi, ${appData.user.name}!`;
                    }
                }
                navItems.forEach(item => item.classList.toggle('is-active', item.dataset.page === pageId));
                window.scrollTo(0,0);
            };
            
            const calculateCurrentChallengeDay = () => { /* ... (same) ... */ if (!appData.user || !appData.user.registrationDate) return { week: 1, day: 1, overallDay: 1 }; const regDate = new Date(appData.user.registrationDate); const today = new Date(); regDate.setHours(0,0,0,0); today.setHours(0,0,0,0); const diffTime = Math.abs(today - regDate); const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); let overallDay = diffDays + 1; if (overallDay > TOTAL_DAYS) overallDay = TOTAL_DAYS; const currentWeek = Math.min(TOTAL_WEEKS, Math.floor((overallDay -1) / DAYS_IN_WEEK) + 1); const dayInWeek = ((overallDay -1) % DAYS_IN_WEEK) + 1; return { week: currentWeek, day: dayInWeek, overallDay: overallDay };};
            const getTodayProgressKey = () => { /* ... (same) ... */ const { week, day } = calculateCurrentChallengeDay(); return `week${week}day${day}`; };
            const getProgressForToday = (createIfMissing = true) => { /* ... (same, ensure peace.llmChat is initialized as []) ... */
                const key = getTodayProgressKey();
                if (!appData.dailyProgress[key] && createIfMissing) {
                    appData.dailyProgress[key] = {
                        sleep: { completed: false, bedtime: '', wakeup: '', duration: '', targetMet: null },
                        weight: { completed: false, meals: [], water: 0, foodLog: '', nonWater: '', junkAvoided: false, fruitSnacks: false, adheredMealTimes: false, calories: null },
                        exercise: { completed: false, cardioDone: false, strengthDone: false },
                        peace: { completed: false, mindfulnessDone: false, moodBefore: 3, stressBefore: 3, moodAfter: 3, stressAfter: 3, breathingDone: false, enjoyableActivityDone: false, llmChat: [] },
                        tasksCompletedCount: 0 
                    };
                }
                return appData.dailyProgress[key] || null;
            };

            const updateThemeMeta = (isLight) => { /* ... (same) ... */ };
            const applyTheme = (isLight) => { /* ... (same) ... */ };
            
            navItems.forEach(item => {item.addEventListener('click', (e) => {e.preventDefault(); const pageId = item.dataset.page; showPage(pageId); if (pageId === 'quit-page') renderQuitHabitPage(); if (pageId === 'progress-page') renderProgressPage();});});
            function setupModal(modalElement, openButtons, closeButtonsSelectors) { /* ... (same) ... */ }
            const motivateModalControls = setupModal(motivateMeModal, motivateMeNowButtonMain, '.modal-background, .delete, .modal-close-button');
            const llmChatModalControls = setupModal(llmChatModal, null, '.modal-background, .delete, .modal-close-button');

            const handleRegistration = (e) => { /* ... (same, ensure updateAppBarGamificationDisplay() at end) ... */ e.preventDefault(); const name = document.getElementById('reg-name').value; const age = parseInt(document.getElementById('reg-age').value); const gender = document.getElementById('reg-gender').value; const weight = parseFloat(document.getElementById('reg-weight').value); const height = parseInt(document.getElementById('reg-height').value); const heightM = height / 100; const idealBmiHealthy = 22; const idealWeight = Math.round(idealBmiHealthy * (heightM * heightM)); let bmr; if (gender === 'male') { bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age); } else if (gender === 'female') { bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age); } else { bmr = (88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age) + 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age)) / 2;} const caloricDeficit = 500; appData.user = { name, age, gender, weight, height, registrationDate: new Date().toISOString(), idealWeight, caloricDeficit, bmr: Math.round(bmr), exerciseTrack: null, currentDayOfYear: getDayOfYear(), lastLoginDayOfYear: getDayOfYear() }; appData.gamification = { points: 0, badges: [], dailyStreak: 0, lastWeightLog: { date: new Date().toISOString().split('T')[0], weight: weight } }; appData.dailyProgress = {}; appData.weeklyGratitude = {}; saveAppData(); showPage('questionnaire-page'); updateAppBarGamificationDisplay();};
            const handleBaseline = (e) => { /* ... (same) ... */  e.preventDefault(); appData.baseline = { cardioValue: parseInt(document.getElementById('baseline-cardio').value), strengthValue: parseInt(document.getElementById('baseline-strength').value) }; saveAppData(); showPage('exercise-track-selection-page');};
            const handleTrackSelection = (track) => { /* ... (same) ... */ appData.user.exerciseTrack = track; saveAppData(); initializeAppDashboard(); };
            document.getElementById('registration-form')?.addEventListener('submit', handleRegistration);
            document.getElementById('baseline-form')?.addEventListener('submit', handleBaseline);
            document.querySelectorAll('#exercise-track-selection-page .button').forEach(btn => btn.addEventListener('click', () => handleTrackSelection(btn.dataset.track)));

            const requestNotificationPermission = async () => { /* ... (same) ... */ }; const showDailyReminderNotification = () => { /* ... (same) ... */ };
            document.getElementById('request-notification-permission')?.addEventListener('click', async () => { /* ... (same) ... */ });
            document.getElementById('notifications-enabled-switch')?.addEventListener('change', async (e) => { /* ... (same) ... */ });

            // --- Home Page Task Messages ---
            const renderHomePageTaskMessages = () => {
                if (!homeTaskMessageList || !appData.user) return;
                homeTaskMessageList.innerHTML = ''; // Clear previous
                const todayProgress = getProgressForToday();
                const { week, day, overallDay } = calculateCurrentChallengeDay();

                if (overallDay > TOTAL_DAYS) {
                     homeTaskMessageList.innerHTML = `<article class="message is-success"><div class="message-body has-text-centered"><strong>Congratulations!</strong> You've completed the 10 Week Challenge!</div></article>`;
                     return;
                }

                const tasks = [
                    { id: 'sleep', name: 'Sleep Goals', icon: 'fa-bed', targetPage: 'sleep-task-page' },
                    { id: 'weight', name: 'Weight Control', icon: 'fa-balance-scale-right', targetPage: 'weight-task-page' },
                    { id: 'exercise', name: 'Daily Exercise', icon: 'fa-dumbbell', targetPage: 'exercise-task-page' },
                    { id: 'peace', name: 'Peace of Mind', icon: 'fa-brain', targetPage: 'peace-task-page' },
                    { id: 'habit', name: `Habit: ${appData.habitChallenge.behaviorName}`, icon: 'fa-route', targetPage: 'quit-page' } // Uses existing quit-page
                ];

                tasks.forEach(task => {
                    const isCompleted = (task.id === 'habit') ? 
                                        (appData.habitChallenge.log[getTodayProgressKey()]?.completedToday || false) : 
                                        (todayProgress[task.id]?.completed || false);
                    const statusText = isCompleted ? 'Complete' : 'Incomplete';
                    const messageClass = isCompleted ? 'is-success is-completed' : 'is-info'; // Or is-warning for incomplete

                    const article = document.createElement('article');
                    article.className = `message ${messageClass}`;
                    article.dataset.targetPage = task.targetPage; // For click navigation
                    article.dataset.taskType = task.id; // For identifying task

                    const header = document.createElement('div');
                    header.className = 'message-header';
                    header.innerHTML = `<p><span class="icon is-small mr-1"><i class="fas ${task.icon}"></i></span>${task.name}</p>`;
                    
                    const body = document.createElement('div');
                    body.className = 'message-body';
                    body.innerHTML = `Status: <strong>${statusText}</strong>. Tap to view/update.`;

                    article.appendChild(header);
                    article.appendChild(body);
                    homeTaskMessageList.appendChild(article);

                    article.addEventListener('click', () => {
                        // Before showing the task page, render its content
                        if (task.id === 'sleep') renderSleepTaskPage(week,day,todayProgress.sleep);
                        else if (task.id === 'weight') renderWeightTaskPage(week,day,todayProgress.weight);
                        else if (task.id === 'exercise') renderExerciseTaskPage(week,day,todayProgress.exercise);
                        else if (task.id === 'peace') renderPeaceTaskPage(week,day,todayProgress.peace);
                        // Habit page (quit-page) is handled by its own nav item click or here if direct nav desired
                        showPage(task.targetPage);
                    });
                });
            };

            // --- Task Specific Page Rendering Functions (NEW) ---
            // These will take the content from the old create...Card functions
            function renderSleepTaskPage(week, day, sleepData) {
                const contentDiv = document.getElementById('sleep-task-content');
                contentDiv.innerHTML = ''; // Clear previous
                // Build HTML similar to createSleepCard but for a full page section
                // Example structure:
                let html = `<div class="box"><h3 class="title is-4">Log Your Sleep</h3>`;
                // ... (Add input fields for bedtime, wake-up, etc., based on week)
                if (week === 1) {
                    html += `<p class="is-size-7 mb-2">Week 1: Track your natural sleep patterns.</p> <div class="field"><label class="label">Bedtime</label><div class="control"><input type="time" class="input sleep-input" data-field="bedtime" value="${sleepData.bedtime || ''}"></div></div> <div class="field"><label class="label">Wake-up Time</label><div class="control"><input type="time" class="input sleep-input" data-field="wakeup" value="${sleepData.wakeup || ''}"></div></div>`;
                } else { 
                    const targetBedtime = "22:00", targetWakeup = "06:00";
                    html += `<p class="is-size-7 mb-2">Target: Bed by ${targetBedtime}, Awake by ${targetWakeup}.</p> <div class="field"><label class="label">Actual Bedtime</label><div class="control"><input type="time" class="input sleep-input" data-field="bedtime" value="${sleepData.bedtime || ''}"></div></div> <div class="field"><label class="label">Actual Wake-up Time</label><div class="control"><input type="time" class="input sleep-input" data-field="wakeup" value="${sleepData.wakeup || ''}"></div></div> <p class="is-size-7 mt-1">Met Target (±30min): <strong id="sleep-target-met-page">${sleepData.targetMet === null ? 'Pending' : (sleepData.targetMet ? 'Yes' : 'No')}</strong></p>`;
                }
                html += `<p class="is-size-7 mt-1">Total Sleep: <strong id="sleep-duration-page">${sleepData.duration || 'N/A'}</strong></p>`;
                html += createTaskDoneCheckbox('sleep', sleepData.completed, 'Mark Sleep Tracking as Complete?'); // Use existing helper
                html += `</div>`;
                contentDiv.innerHTML = html;
                // Re-attach event listeners for inputs on this page
                setupSleepTaskPageListeners();
            }
            // Create renderWeightTaskPage, renderExerciseTaskPage, renderPeaceTaskPage similarly

            function setupSleepTaskPageListeners() {
                document.querySelectorAll('#sleep-task-page .sleep-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const field = e.target.dataset.field;
                        getProgressForToday().sleep[field] = e.target.value;
                        const { bedtime, wakeup } = getProgressForToday().sleep;
                        if (bedtime && wakeup) { /* ... (calculation logic from old setupCardEventListeners) ... */ 
                            const [bh, bm] = bedtime.split(':').map(Number); const [wh, wm] = wakeup.split(':').map(Number); let diffMins = (wh * 60 + wm) - (bh * 60 + bm); if (diffMins < 0) diffMins += 24 * 60; const hours = Math.floor(diffMins / 60); const mins = diffMins % 60; getProgressForToday().sleep.duration = `${hours}h ${mins}m`; 
                            const durationDisplay = document.getElementById('sleep-duration-page'); if(durationDisplay) durationDisplay.textContent = getProgressForToday().sleep.duration;
                            const { week } = calculateCurrentChallengeDay();
                            if(week > 1) { 
                                const targetBedtimeMins = 22 * 60; const targetWakeupMins = 6 * 60;
                                const actualBedtimeMins = bh * 60 + bm; let actualWakeupRelativeMins = (wh * 60 + wm);
                                // Normalize actual bedtime to be before target wakeup if it crosses midnight from target perspective
                                let normalizedActualBedtime = actualBedtimeMins;
                                if (actualBedtimeMins > 12*60 && targetWakeupMins < 12*60) { // Bedtime PM, target wakeup AM
                                    // if actual bedtime is e.g. 23:00 and target is 06:00. No normalization needed for this condition.
                                } else if (actualBedtimeMins < 12*60 && targetBedtimeMins > 12*60) { // Bedtime AM (e.g. 01:00) but target was PM (22:00)
                                     normalizedActualBedtime += 24*60; // treat as next day's AM
                                }
                                // Normalize actual wakeup to be after target bedtime
                                let normalizedActualWakeup = actualWakeupRelativeMins;
                                if (actualWakeupRelativeMins < targetBedtimeMins && Math.abs(actualWakeupRelativeMins - targetBedtimeMins) > 12*60) { // if wakeup is AM and target bedtime PM
                                    normalizedActualWakeup += 24*60;
                                }
                                const isBedtimeMet = Math.abs(normalizedActualBedtime - targetBedtimeMins) <= 30;
                                const isWakeupMet = Math.abs(normalizedActualWakeup - (targetBedtimeMins + 8*60)) <=30 || Math.abs(normalizedActualWakeup - targetWakeupMins) <=30; // Check against target wakeup OR 8h after target bed.

                                getProgressForToday().sleep.targetMet = isBedtimeMet && isWakeupMet; // Simplified, refine logic if needed
                                const targetMetDisplay = document.getElementById('sleep-target-met-page'); if(targetMetDisplay) targetMetDisplay.textContent = getProgressForToday().sleep.targetMet ? 'Yes' : 'No';
                            }
                        }
                        saveAppData(); updateAppBarGamificationDisplay();
                    });
                });
                document.querySelector('#sleep-task-page .task-overall-done-checkbox[data-tasktype="sleep"]')?.addEventListener('change', handleTaskOverallCompleteChange);
            }
            // Define setupWeightTaskPageListeners etc.

            const handleTaskOverallCompleteChange = (e) => { // Generic handler for task page "overall complete"
                const taskType = e.target.dataset.tasktype;
                const isChecked = e.target.checked;
                const icon = e.target.parentElement.querySelector('.icon i');
                getProgressForToday()[taskType].completed = isChecked;
                if (isChecked) { icon.className = 'far fa-check-square'; addPoints(10); } 
                else { icon.className = 'far fa-square'; addPoints(-10); }
                checkAllDailyTasksCompletion(); updateAppBarGamificationDisplay(); saveAppData();
            };


            // --- Progress Page: Calendar ---
            function renderProgressCalendar() {
                const calendarGrid = document.getElementById('progress-calendar-grid');
                if (!calendarGrid || !appData.user) return;
                calendarGrid.innerHTML = ''; // Clear previous

                const { overallDay: currentOverallDay } = calculateCurrentChallengeDay();

                for (let dayNum = 1; dayNum <= TOTAL_DAYS; dayNum++) {
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day';
                    
                    const weekForDay = Math.floor((dayNum -1) / DAYS_IN_WEEK) + 1;
                    const dayInWeekForDay = ((dayNum -1) % DAYS_IN_WEEK) + 1;
                    dayDiv.textContent = `D${dayNum}`; // Simple display

                    const progressKey = `week${weekForDay}day${dayInWeekForDay}`;
                    const dayProgress = appData.dailyProgress[progressKey];
                    
                    if (dayNum > currentOverallDay) {
                        dayDiv.classList.add('is-future');
                    } else if (dayProgress) {
                        // Check if all main tasks for that historical day were complete
                        const mainTasks = ['sleep', 'weight', 'exercise', 'peace'];
                        const allMainDone = mainTasks.every(task => dayProgress[task]?.completed);
                        const habitDone = appData.habitChallenge.log[progressKey]?.completedToday;
                        if (allMainDone && habitDone) {
                            dayDiv.classList.add('is-completed');
                            dayDiv.title = `All tasks completed!`;
                        } else {
                            const tasksDoneCount = mainTasks.filter(t => dayProgress[t]?.completed).length + (habitDone ? 1 : 0);
                            dayDiv.title = `${tasksDoneCount} / 5 tasks done`;
                            // Could add partial completion color if desired
                        }
                    } else if (dayNum < currentOverallDay) {
                         dayDiv.title = `Data not available / Missed`; // Missed day before current
                    }
                    calendarGrid.appendChild(dayDiv);
                }
            }


            let mindfulnessInterval; // (Keep existing mindfulness logic from old setupCardEventListeners)
            function startMindfulnessTimer() { /* ... (same) ... */ }
            function renderQuitHabitPage() { /* ... (same) ... */ }
            function renderProgressPage() { 
                if (!appData.user) return;
                renderProgressCalendar(); // New call
                // Rest of progress page data fill (same as before)
                document.getElementById('prog-initial-weight').textContent = appData.user.weight;
                document.getElementById('prog-target-weight').textContent = appData.user.idealWeight;
                const loggedWeightInput = document.getElementById('prog-log-current-weight');
                const loggedWeightDisplay = document.getElementById('prog-current-weight-display');
                if(appData.gamification.lastWeightLog) { if(loggedWeightInput) loggedWeightInput.value = appData.gamification.lastWeightLog.weight; if(loggedWeightDisplay) loggedWeightDisplay.textContent = `${appData.gamification.lastWeightLog.weight} (on ${new Date(appData.gamification.lastWeightLog.date).toLocaleDateString()})`; } else { if(loggedWeightInput) loggedWeightInput.value = ''; if(loggedWeightDisplay) loggedWeightDisplay.textContent = 'N/A';}
                if(appData.baseline) { document.getElementById('prog-baseline-cardio').textContent = appData.baseline.cardioValue; document.getElementById('prog-baseline-strength').textContent = appData.baseline.strengthValue;}
                let totalMood = 0, moodCount = 0, totalStress = 0, stressCount = 0; Object.values(appData.dailyProgress).forEach(dayData => { if(dayData.peace) { if(dayData.peace.moodAfter) { totalMood += dayData.peace.moodAfter; moodCount++; } if(dayData.peace.stressAfter) { totalStress += dayData.peace.stressAfter; stressCount++; }}});
                document.getElementById('prog-avg-mood').textContent = moodCount > 0 ? (totalMood/moodCount).toFixed(1) : 'N/A';
                document.getElementById('prog-avg-stress').textContent = stressCount > 0 ? (totalStress/stressCount).toFixed(1) : 'N/A';
            }
            document.getElementById('save-prog-current-weight')?.addEventListener('click', () => { /* ... */ });

            const addPoints = (amount) => { appData.gamification.points = Math.max(0, appData.gamification.points + amount); };
            const awardBadge = (badgeName, badgeIconClass) => { /* ... (same) ... */ };
            const updateAppBarGamificationDisplay = () => { /* ... (same, targets app-bar elements) ... */ if (!appData.user || !appBarUserPoints) return; appBarUserPoints.textContent = appData.gamification.points; appBarUserStreak.textContent = `${appData.gamification.dailyStreak}d`; const { week, day, overallDay } = calculateCurrentChallengeDay(); appBarChallengeProgressBar.value = overallDay; appBarChallengeProgressBar.max = TOTAL_DAYS; appBarChallengeProgressText.textContent = `W${week} D${day}`; const badgesDisplay = document.getElementById('badges-display'); if(badgesDisplay) { badgesDisplay.innerHTML = ''; appData.gamification.badges.forEach(badge => { badgesDisplay.innerHTML += `<span class="tag is-medium is-success"><span class="icon is-small mr-1"><i class="${badge.icon}"></i></span>${badge.name}</span>`; });}};
            const checkAllDailyTasksCompletion = () => { /* ... (same, calls updateAppBarGamificationDisplay) ... */ };
            const checkAndAwardWeeklyBadges = (weekCompleted) => { /* ... (same, calls updateAppBarGamificationDisplay) ... */ };

            const getLLMSimulatedResponse = (type, input, context = null) => { /* ... (same) ... */ return new Promise(r => setTimeout(()=>r("Simulated LLM response."),100)); };
            document.getElementById('get-motivation-button')?.addEventListener('click', async () => { /* ... */ });
            let peaceChatHistory = []; const llmChatHistoryPeaceDiv = document.getElementById('llm-chat-history-peace'); const llmChatInputPeace = document.getElementById('llm-chat-input-peace');
            const renderLlmChatHistory = (contextType) => { /* ... (same) ... */ };
            document.getElementById('llm-chat-send-peace')?.addEventListener('click', async () => { /* ... */ });

            const initializeAppDashboard = () => {
                if (!appData.user) { showPage('registration-page'); return; }
                const homeTitleBar = document.getElementById('home-page-title-bar');
                if (homeTitleBar) homeTitleBar.textContent = `Hi, ${appData.user.name}!`;
                
                showPage('home-page'); 
                updateAppBarGamificationDisplay(); // Ensure app bar is up-to-date

                const { week, day, overallDay } = calculateCurrentChallengeDay();
                appData.user.currentWeek = week;
                const todayOfYear = getDayOfYear();
                const welcomeMsgDiv = document.getElementById('welcome-back-message');
                if (appData.user.lastLoginDayOfYear) {
                    if (todayOfYear === appData.user.lastLoginDayOfYear) { welcomeMsgDiv.style.display = 'none'; } 
                    else if (todayOfYear === appData.user.lastLoginDayOfYear + 1) { welcomeMsgDiv.style.display = 'none'; } 
                    else { appData.gamification.dailyStreak = 0; welcomeMsgDiv.textContent = `Welcome back, ${appData.user.name}! Back on Week ${week}, Day ${day}.`; welcomeMsgDiv.style.display = 'block'; }
                }
                appData.user.lastLoginDayOfYear = todayOfYear;

                const userInfoDiv = document.getElementById('user-info-dashboard');
                if (userInfoDiv) { userInfoDiv.innerHTML = `<p><strong>Name:</strong> ${appData.user.name}</p><p><strong>Track:</strong> ${appData.user.exerciseTrack ? appData.user.exerciseTrack.charAt(0).toUpperCase() + appData.user.exerciseTrack.slice(1) : 'N/A'}</p><p><strong>Ideal W:</strong> ${appData.user.idealWeight} kg (BMR: ~${appData.user.bmr} kcal)</p>`;}
                
                renderHomePageTaskMessages(); // NEW: Render messages instead of cards

                const todayProgressExists = getProgressForToday(false);
                const allTasksDoneToday = todayProgressExists ? Object.values(todayProgressExists).every(task => typeof task === 'object' ? task.completed : true) && appData.habitChallenge.log[getTodayProgressKey()]?.completedToday : false;
                const dailyReminderDiv = document.getElementById('daily-task-reminder');
                if (!allTasksDoneToday) { dailyReminderDiv.style.display = 'block'; showDailyReminderNotification(); } 
                else { dailyReminderDiv.style.display = 'none'; }
                saveAppData();
            };

            document.getElementById('reset-app-data')?.addEventListener('click', () => { /* ... (same) ... */ });
            document.getElementById('community-forum-link')?.addEventListener('click', () => { /* ... (same) ... */ });

            loadAppData();
            applyTheme(appData.settings.theme === 'light'); 
            if (themeToggleCheckbox) { themeToggleCheckbox.addEventListener('change', () => applyTheme(themeToggleCheckbox.checked)); }
            const notificationsSwitch = document.getElementById('notifications-enabled-switch');
            if(notificationsSwitch) notificationsSwitch.checked = appData.settings.notificationsEnabled;
            
            updateAppBarGamificationDisplay();

            const splashTimeout = (appData.user && appData.user.registrationDate) ? 1000 : 2600;
            setTimeout(() => {
                const splash = document.getElementById('splash-page');
                if (splash) splash.style.opacity = '0';
                setTimeout(() => {
                     if (splash) splash.style.display = 'none';
                     // ShowPag will handle app bar visibility
                     if (!appData.user) { showPage('registration-page'); } 
                     else if (!appData.baseline) { showPage('questionnaire-page'); } 
                     else if (!appData.user.exerciseTrack) { showPage('exercise-track-selection-page'); } 
                     else { initializeAppDashboard(); } // This calls showPage('home-page')
                }, 500); 
            }, splashTimeout - 500);
        });
    </script>
</body>
</html>